{% extends "base.html" %}

{% block title %}Admin Dashboard - Hack Club Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    .admin-container {
        padding: 2rem 0;
        min-height: calc(100vh - 200px);
    }
    .admin-container {
        padding: 2rem 0;
        min-height: calc(100vh - 200px);
    }

    .admin-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem;
        background: linear-gradient(135deg, #ec3750 0%, #ff6b7a 100%);
        color: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(236, 55, 80, 0.3);
    }

    .admin-header h1 {
        font-size: 3rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .admin-header p {
        font-size: 1.2rem;
        opacity: 0.9;
        margin: 0;
    }

    .admin-nav {
        display: flex;
        gap: 1rem;
        margin-bottom: 3rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .admin-tab {
        background: white;
        border: 2px solid #e2e8f0;
        color: #64748b;
        padding: 1rem 2rem;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .admin-tab:hover {
        background: #f8fafc;
        border-color: #ec3750;
        color: #ec3750;
        transform: translateY(-2px);
    }

    .admin-tab.active {
        background: #ec3750;
        border-color: #ec3750;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(236, 55, 80, 0.3);
    }

    .admin-section {
        display: none;
    }

    .admin-section.active {
        display: block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
    }

    .chart-card h3 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        color: #1a202c;
        font-weight: 700;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient);
    }

    .stat-card.users::before { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stat-card.clubs::before { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.posts::before { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-card.assignments::before { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .stat-card.tokens::before { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-card.balance::before { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.approved-grants::before { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.submitted-grants::before { background: linear-gradient(135deg, #ec3750, #d63146); }
    .stat-card.pending-projects::before { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-card.approved-projects::before { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.rejected-projects::before { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .stat-card.airtable-status::before { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .stat-card.ratio::before { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        border-color: #cbd5e0;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: white;
        margin-bottom: 0.75rem;
    }

    .stat-card.users .stat-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stat-card.clubs .stat-icon { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.posts .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-card.assignments .stat-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .stat-card.tokens .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-card.balance .stat-icon { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.approved-grants .stat-icon { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.submitted-grants .stat-icon { background: linear-gradient(135deg, #ec3750, #d63146); }
    .stat-card.pending-projects .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-card.approved-projects .stat-icon { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.rejected-projects .stat-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .stat-card.airtable-status .stat-icon { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .stat-card.ratio .stat-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

    .stat-number {
        font-size: 1.75rem;
        font-weight: 800;
        color: #1a202c;
        margin-bottom: 0.25rem;
        line-height: 1;
    }

    .stat-label {
        color: #64748b;
        font-weight: 500;
        font-size: 0.75rem;
        line-height: 1.3;
    }

    .data-table {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }

    .table-header {
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        padding: 2rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-header h3 {
        margin: 0;
        color: #1a202c;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .search-box {
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        width: 300px;
        transition: all 0.2s ease;
    }

    .search-box:focus {
        outline: none;
        border-color: #ec3750;
        box-shadow: 0 0 0 3px rgba(236, 55, 80, 0.1);
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
        margin: 0;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e0;
        transition: 0.3s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
        background-color: #ec3750;
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }

    .toggle-switch input:focus + .toggle-slider {
        box-shadow: 0 0 0 3px rgba(236, 55, 80, 0.1);
    }

    .table-content {
        padding: 0;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 1.5rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }

    th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    td {
        color: #4b5563;
    }

    tr:hover {
        background: #f8fafc;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-admin {
        background: #fef3c7;
        color: #92400e;
    }

    .status-reviewer {
        background: #f3e8ff;
        color: #7c3aed;
    }

    .status-user {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-suspended {
        background: #fee2e2;
        color: #dc2626;
    }

    .status-active {
        background: #d1fae5;
        color: #065f46;
    }

    .action-buttons {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 0.4rem 0.75rem;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        white-space: nowrap;
        min-width: auto;
        text-decoration: none;
    }

    .btn-action i {
        font-size: 0.7rem;
    }

    .btn-edit {
        background: #3b82f6;
        color: white;
    }

    .btn-edit:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }

    .btn-delete {
        background: #ef4444;
        color: white;
    }

    .btn-delete:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }

    .btn-suspend {
        background: #f59e0b;
        color: white;
    }

    .btn-suspend:hover {
        background: #d97706;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    }

    .btn-login {
        background: #10b981;
        color: white;
    }

    .btn-login:hover {
        background: #059669;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }

    .btn-reset {
        background: #8b5cf6;
        color: white;
    }

    .btn-reset:hover {
        background: #7c3aed;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
    }

    /* Custom Dropdown Styles */
    .action-dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-toggle {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 80px;
        justify-content: center;
    }

    .dropdown-toggle:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .dropdown-menu {
        position: fixed;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        min-width: 160px;
        z-index: 999999;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        pointer-events: none;
    }

    .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #374151;
        text-decoration: none;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f3f4f6;
    }

    .dropdown-item:last-child {
        border-bottom: none;
    }

    .dropdown-item:hover {
        background: #f8fafc;
        color: #1f2937;
    }

    .dropdown-item.edit:hover {
        background: #dbeafe;
        color: #1e40af;
    }

    .dropdown-item.login:hover {
        background: #d1fae5;
        color: #065f46;
    }

    .dropdown-item.reset:hover {
        background: #ede9fe;
        color: #5b21b6;
    }

    .dropdown-item.suspend:hover {
        background: #fef3c7;
        color: #92400e;
    }

    .dropdown-item.transfer:hover {
        background: #dbeafe;
        color: #1e40af;
    }

    .dropdown-item.danger:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    .dropdown-item i {
        width: 14px;
        text-align: center;
        font-size: 0.8rem;
    }

    /* User search dropdown styles */
    .user-search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 2px;
    }

    .user-search-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .user-search-item:last-child {
        border-bottom: none;
    }

    .user-search-item:hover {
        background: #f8fafc;
    }

    .user-search-item.selected {
        background: #dbeafe;
        color: #1e40af;
    }

    .user-search-name {
        font-weight: 500;
        color: #1f2937;
    }

    .user-search-email {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }

    .user-search-no-results {
        padding: 1rem;
        text-align: center;
        color: #6b7280;
        font-style: italic;
    }

    /* Pagination Styles */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1.5rem;
        padding: 1rem 0;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .pagination-info {
        color: #64748b;
        font-size: 0.875rem;
        order: 1;
    }

    .pagination {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
    }

    .pagination-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        order: 2;
    }

    .pagination-btn {
        background: white;
        border: 1px solid #e2e8f0;
        color: #374151;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        min-width: 40px;
        justify-content: center;
    }

    .pagination-btn:hover:not(:disabled) {
        background: #f8fafc;
        border-color: #ec3750;
        color: #ec3750;
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-btn.active {
        background: #ec3750;
        border-color: #ec3750;
        color: white;
    }

    .page-size-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        order: 3;
        justify-content: center;
        font-size: 0.875rem;
        color: #64748b;
    }

    .page-size-selector select {
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
    }

    .activity-feed {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }

    .activity-item {
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s ease;
    }

    .activity-item:hover {
        background: #f8fafc;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
        background: linear-gradient(135deg, #ec3750, #d63146);
    }

    .activity-content {
        flex: 1;
    }

    .activity-content h4 {
        margin: 0 0 0.25rem 0;
        color: #1a202c;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .activity-content p {
        margin: 0;
        color: #64748b;
        font-size: 0.875rem;
    }

    .activity-time {
        color: #9ca3af;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1000000;
        backdrop-filter: blur(5px);
    }

    .modal-backdrop.show {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 120px;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transform: scale(0.9);
        transition: all 0.3s ease;
    }

    .modal-backdrop.show .modal-content {
        transform: scale(1);
    }

    .modal-header {
        padding: 2rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        color: #1a202c;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #9ca3af;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1.5rem 2rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    /* IP Lookup Styles */
    .status-badge.status-info {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }

    .user-info {
        line-height: 1.4;
    }

    code {
        background: #f1f5f9;
        color: #475569;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem;
    }

    .badge-primary { background-color: #3b82f6; }
    .badge-warning { background-color: #f59e0b; }
    .badge-danger { background-color: #ef4444; }
    .badge-success { background-color: #10b981; }
    .badge-secondary { background-color: #6b7280; }
    .badge-info { background-color: #06b6d4; }

    #ipLookupResults {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    #ipLookupTitle {
        color: #1e293b;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .text-muted {
        color: #64748b;
        font-style: italic;
    }

    @media (max-width: 768px) {
        .admin-header h1 {
            font-size: 2rem;
        }

        .admin-nav {
            flex-direction: column;
            align-items: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .table-header {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .search-box {
            width: 100%;
        }

        .action-buttons {
            flex-direction: column;
        }
    }

    .loading {
        text-align: center;
        padding: 3rem;
        color: #64748b;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-radius: 50%;
        border-top-color: #ec3750;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .redirect-uris code {
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        word-break: break-all;
    }

    .scope-tag {
        display: inline-block;
        background: #dbeafe;
        color: #1e40af;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.75rem;
        margin: 0.125rem;
        font-weight: 500;
    }

    .scopes-list {
        line-height: 1.8;
    }

    .form-help {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    /* Audit Log Specific Styles */
    .logs-table tr {
        transition: all 0.2s ease;
    }

    .logs-table tr:hover {
        background: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .status-info {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-warning {
        background: #fef3c7;
        color: #92400e;
    }

    #logDetailsModal .modal-content {
        max-width: 700px;
    }

    .log-detail-grid {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 1rem;
        align-items: start;
    }

    .log-detail-grid strong {
        color: #374151;
        font-weight: 600;
    }

    /* Toggle Switch Styles */
    .toggle-switch {
        position: relative;
        display: inline-block;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-label {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
        background-color: #ccc;
        border-radius: 34px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .toggle-label:hover {
        background-color: #bbb;
    }

    .toggle-slider {
        position: absolute;
        top: 4px;
        left: 4px;
        width: 26px;
        height: 26px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch input:checked + .toggle-label {
        background-color: #10b981;
    }

    .toggle-switch input:checked + .toggle-label:hover {
        background-color: #059669;
    }

    .toggle-switch input:checked + .toggle-label .toggle-slider {
        transform: translateX(26px);
    }

    .setting-item {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
        transition: box-shadow 0.2s ease;
    }

    .setting-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* User view controls */
    .user-view-controls {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .user-view-controls .btn-sm.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Grouped views */
    .user-group {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .group-header {
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .group-header:hover {
        background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
    }

    .group-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .group-count {
        background: var(--primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .group-content {
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
    }

    .group-content.collapsed {
        display: none;
    }

    .user-mini-card {
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s ease;
    }

    .user-mini-card:hover {
        background: #f8fafc;
    }

    .user-mini-card:last-child {
        border-bottom: none;
    }

    .user-mini-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .user-mini-name {
        font-weight: 600;
        color: #111827;
    }

    .user-mini-email {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .user-mini-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .collapse-icon {
        transition: transform 0.2s ease;
    }

    .collapse-icon.collapsed {
        transform: rotate(-90deg);
    }

    /* Badges for user meta */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 12px;
        text-transform: uppercase;
    }

    .badge-admin {
        background: #fef3c7;
        color: #d97706;
    }

    .badge-reviewer {
        background: #dbeafe;
        color: #2563eb;
    }

    .badge-suspended {
        background: #fee2e2;
        color: #dc2626;
    }

    .badge-role {
        background: #f3f4f6;
        color: #374151;
    }

    /* Group controls */
    .group-controls {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        border: 1px solid #e5e7eb;
    }

    .group-sort-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .group-sort-controls label {
        font-weight: 500;
        color: #374151;
    }

    .group-sort-controls select {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: white;
        color: #374151;
    }

    .group-info {
        font-size: 0.9rem;
        color: #6b7280;
    }

    @media (max-width: 768px) {
        .group-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .group-sort-controls {
            justify-content: center;
        }
    }

    /* Role Management Styles */
    .role-tab {
        background: white;
        border: none;
        border-bottom: 3px solid transparent;
        color: #64748b;
        padding: 1rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        font-size: 1rem;
    }

    .role-tab:hover {
        color: #ec3750;
        background: #fef2f2;
    }

    .role-tab.active {
        color: #ec3750;
        border-bottom-color: #ec3750;
        background: #fef2f2;
    }

    .role-tab-content {
        display: none;
        padding: 1.5rem;
    }

    .role-tab-content.active {
        display: block;
    }

    .role-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .role-card:hover {
        border-color: #ec3750;
        box-shadow: 0 4px 12px rgba(236, 55, 80, 0.1);
    }

    .role-card.system-role {
        border-left: 4px solid #3b82f6;
    }

    .role-card.custom-role {
        border-left: 4px solid #10b981;
    }

    .permission-badge {
        display: inline-block;
        background: #f1f5f9;
        color: #475569;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        margin: 0.25rem;
        font-weight: 500;
    }

    .permission-category {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .permission-category h5 {
        color: #1e293b;
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .permission-item {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #e2e8f0;
    }

    .user-role-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .user-role-card.root-user {
        border-left: 4px solid #fbbf24;
        background: #fffbeb;
    }

</style>
{% endblock %}

{% block content %}
<div class="container admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-crown"></i> Admin Stuff</h1>
        <p>Manage users, clubs, and everything in between</p>
    </div>

    <div class="admin-nav">
        <button class="admin-tab active" onclick="showAdminSection('overview')" data-section="overview">
            <i class="fas fa-chart-pie"></i> Overview
        </button>
        {% if can_view_users %}
        <button class="admin-tab" onclick="showAdminSection('users')" data-section="users">
            <i class="fas fa-users"></i> Users
        </button>
        {% endif %}
        {% if can_view_clubs %}
        <button class="admin-tab" onclick="showAdminSection('clubs')" data-section="clubs">
            <i class="fas fa-flag"></i> Clubs
        </button>
        {% endif %}
        {% if can_view_activity %}
        <button class="admin-tab" onclick="showAdminSection('activity')" data-section="activity">
            <i class="fas fa-stream"></i> Activity
        </button>
        {% endif %}
        {% if can_manage_roles or can_manage_users %}
        <button class="admin-tab" onclick="showAdminSection('roles')" data-section="roles">
            <i class="fas fa-user-shield"></i> Roles & Permissions
        </button>
        {% endif %}
        {% if can_manage_settings %}
        <button class="admin-tab" onclick="showAdminSection('settings')" data-section="settings">
            <i class="fas fa-cogs"></i> Settings
        </button>
        {% endif %}
    </div>

    <div class="admin-section active" id="overview">
        <!-- Quick Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card users">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-number">{{ total_users }}</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card clubs">
                <div class="stat-icon"><i class="fas fa-flag"></i></div>
                <div class="stat-number">{{ total_clubs }}</div>
                <div class="stat-label">Total Clubs</div>
            </div>
            <div class="stat-card posts">
                <div class="stat-icon"><i class="fas fa-comment"></i></div>
                <div class="stat-number">{{ total_posts }}</div>
                <div class="stat-label">Posts</div>
            </div>
            <div class="stat-card assignments">
                <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                <div class="stat-number">{{ total_assignments }}</div>
                <div class="stat-label">Assignments</div>
            </div>
            <div class="stat-card tokens">
                <div class="stat-icon"><i class="fas fa-coins"></i></div>
                <div class="stat-number">{{ (total_club_balance * 100)|int|default(0) }}</div>
                <div class="stat-label">Total Tokens</div>
            </div>
            <div class="stat-card balance">
                <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="stat-number">${{ "%.2f"|format(total_club_balance|default(0)) }}</div>
                <div class="stat-label">USD Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);"><i class="fas fa-project-diagram"></i></div>
                <div class="stat-number">{{ total_projects|default(0) }}</div>
                <div class="stat-label">Total Projects</div>
            </div>
            <div class="stat-card pending-projects">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-number">{{ total_pending_projects|default(0) }}</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card approved-projects">
                <div class="stat-icon"><i class="fas fa-check"></i></div>
                <div class="stat-number">{{ total_approved_projects|default(0) }}</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card rejected-projects">
                <div class="stat-icon"><i class="fas fa-times"></i></div>
                <div class="stat-number">{{ total_rejected_projects|default(0) }}</div>
                <div class="stat-label">Rejected</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-percentage"></i></div>
                <div class="stat-number">{{ approval_rate|default(0) }}%</div>
                <div class="stat-label">Approval Rate</div>
            </div>
            <div class="stat-card submitted-grants">
                <div class="stat-icon"><i class="fas fa-gift"></i></div>
                <div class="stat-number">{{ total_submitted_weighted_grants|default(0) }}</div>
                <div class="stat-label">Submitted Grants</div>
            </div>
            <div class="stat-card approved-grants">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-number">{{ total_approved_weighted_grants|default(0) }}</div>
                <div class="stat-label">Approved Grants</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);"><i class="fas fa-hourglass-half"></i></div>
                <div class="stat-number">{{ submitted_hours|default(0)|int }}</div>
                <div class="stat-label">Total Hours</div>
            </div>
            <div class="stat-card airtable-status">
                <div class="stat-icon"><i class="fas fa-database"></i></div>
                <div class="stat-number" style="font-size: 1.2rem;">
                    {% if airtable_status == 'operational' %}
                    <span style="color: #10b981;">✓ Connected</span>
                    {% else %}
                    <span style="color: #ef4444;">✗ Error</span>
                    {% endif %}
                </div>
                <div class="stat-label">Airtable Status</div>
            </div>
            <div class="stat-card ratio">
                <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                <div class="stat-number">{{ users_to_clubs_ratio|default(0) }}</div>
                <div class="stat-label">Users/Clubs Ratio</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);"><i class="fas fa-hourglass-end"></i></div>
                <div class="stat-number">{{ approved_hours|default(0)|int }}</div>
                <div class="stat-label">Approved Hours</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-chart-line"></i></div>
                <div class="stat-number">{{ avg_hours_per_project|default(0) }}</div>
                <div class="stat-label">Avg Hours/Project</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3>Project Status Distribution</h3>
                <canvas id="projectStatusChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Hours Distribution</h3>
                <canvas id="hoursChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Weighted Grants</h3>
                <canvas id="grantsChart"></canvas>
            </div>
        </div>

    </div>

    <div class="admin-section" id="users">
        <div class="data-table">
            <div class="table-header">
                <h3>User Management</h3>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <input type="text" class="search-box" placeholder="Search users..." id="userSearch">
                    <div class="user-sort-controls" style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="userSortSelect" style="font-size: 0.875rem; color: #374151;">Sort by:</label>
                        <select id="userSortSelect" onchange="sortUsers()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                            <option value="created_at-desc">Newest First</option>
                            <option value="created_at-asc">Oldest First</option>
                            <option value="username-asc">Username (A-Z)</option>
                            <option value="username-desc">Username (Z-A)</option>
                            <option value="email-asc">Email (A-Z)</option>
                            <option value="email-desc">Email (Z-A)</option>
                            <option value="suspended-desc">Suspended First</option>
                            <option value="suspended-asc">Active First</option>
                            <option value="role-admin">Admins First</option>
                            <option value="role-user">Regular Users First</option>
                        </select>
                    </div>
                    <div class="user-view-controls">
                        <button class="btn btn-secondary btn-sm active" onclick="setUserView('normal')" id="normalViewBtn">
                            <i class="fas fa-list"></i> Normal View
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="setUserView('group-ip')" id="groupIpBtn">
                            <i class="fas fa-network-wired"></i> Group by IP
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="setUserView('group-club')" id="groupClubBtn">
                            <i class="fas fa-users"></i> Group by Club
                        </button>
                    </div>
                    {% if can_create_users %}
                    <button class="btn btn-success btn-sm" onclick="openModal('createUsersModal')">
                        <i class="fas fa-user-plus"></i> Create Users
                    </button>
                    {% endif %}
                    {% if can_view_users %}
                    <button class="btn btn-primary btn-sm" onclick="exportData('users')">
                        <i class="fas fa-download"></i> Export JSON
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="table-content">
                <div class="loading" id="usersLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading users...</p>
                </div>
                <table id="usersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Clubs</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    </tbody>
                </table>


                <div id="groupByIpView" style="display: none;">
                    <div class="group-controls">
                        <div class="group-sort-controls">
                            <label for="ipSortSelect">Sort by:</label>
                            <select id="ipSortSelect" onchange="sortAndPaginateGroups('ip')">
                                <option value="users-desc">Most Users First</option>
                                <option value="users-asc">Fewest Users First</option>
                                <option value="ip-asc">IP Address (A-Z)</option>
                                <option value="ip-desc">IP Address (Z-A)</option>
                            </select>
                        </div>
                        <div class="group-info">
                            <span id="ipGroupsInfo">Loading...</span>
                        </div>
                    </div>
                    <div id="ipGroupsContainer">

                    </div>
                    <div id="ipGroupsPagination" class="pagination-container"></div>
                </div>


                <div id="groupByClubView" style="display: none;">
                    <div class="group-controls">
                        <div class="group-sort-controls">
                            <label for="clubSortSelect">Sort by:</label>
                            <select id="clubSortSelect" onchange="sortAndPaginateGroups('club')">
                                <option value="users-desc">Most Users First</option>
                                <option value="users-asc">Fewest Users First</option>
                                <option value="name-asc">Club Name (A-Z)</option>
                                <option value="name-desc">Club Name (Z-A)</option>
                            </select>
                        </div>
                        <div class="group-info">
                            <span id="clubGroupsInfo">Loading...</span>
                        </div>
                    </div>
                    <div id="clubGroupsContainer">

                    </div>
                    <div id="clubGroupsPagination" class="pagination-container"></div>
                </div>

                <div id="usersPagination" class="pagination-container"></div>
            </div>
        </div>
    </div>

    <div class="admin-section" id="clubs">
        <div class="data-table">
            <div class="table-header">
                <h3>Club Management</h3>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <input type="text" class="search-box" placeholder="Search clubs..." id="clubSearch">
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                        <label for="includeAirtableToggle" style="font-size: 0.9rem; color: #64748b; margin: 0; cursor: pointer; user-select: none;">
                            Include non-onboarded clubs
                        </label>
                        <label class="toggle-switch" title="Search Airtable for non-onboarded clubs (resource intensive)">
                            <input type="checkbox" id="includeAirtableToggle" onchange="handleClubSearch(document.getElementById('clubSearch').value)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('createClubModal')">
                        <i class="fas fa-plus"></i> Create Club
                    </button>
                    {% if can_view_clubs %}
                    <button class="btn btn-primary btn-sm" onclick="exportData('clubs')" style="margin-left: auto;">
                        <i class="fas fa-download"></i> Export JSON
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="table-content">
                <div class="loading" id="clubsLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading clubs...</p>
                </div>
                <table id="clubsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Club Name</th>
                            <th>Leader</th>
                            <th>Members</th>
                            <th>Location</th>
                            <th>Tokens</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clubsTableBody">
                    </tbody>
                </table>
                <div id="clubsPagination" class="pagination-container"></div>
            </div>
        </div>
    </div>

    {% if can_view_activity %}
    <div class="admin-section" id="activity">
        <div class="data-table">
            <div class="table-header">
                <h3><i class="fas fa-clipboard-list"></i> Comprehensive Audit Logs</h3>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <input type="text" class="search-box" placeholder="Search logs..." id="logsSearch" style="width: 200px;">
                    <select id="categoryFilter" style="padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <option value="">All Categories</option>
                        <option value="auth">Authentication</option>
                        <option value="user">User Management</option>
                        <option value="club">Club Management</option>
                        <option value="project">Project Reviews</option>
                        <option value="admin">Admin Actions</option>
                        <option value="security">Security Events</option>
                        <option value="gallery">Gallery Posts</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="severityFilter" style="padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <option value="">All Severities</option>
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                        <option value="critical">Critical</option>
                    </select>
                    <select id="sortOrder" style="padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <option value="desc">Newest First</option>
                        <option value="asc">Oldest First</option>
                    </select>
                    <button onclick="refreshLogs()" class="btn btn-primary" style="padding: 0.5rem 1rem;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="exportData('audit-logs')" style="margin-left: auto;">
                        <i class="fas fa-download"></i> Export JSON
                    </button>
                </div>
            </div>
            <div class="table-content">
                <div class="loading" id="logsLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading audit logs...</p>
                </div>
                <table id="logsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Timestamp</th>
                            <th style="width: 10%;">User</th>
                            <th style="width: 15%;">Action</th>
                            <th style="width: 10%;">Category</th>
                            <th style="width: 35%;">Description</th>
                            <th style="width: 8%;">Severity</th>
                            <th style="width: 12%;">IP Address</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                    </tbody>
                </table>
                <div id="logsPagination" class="pagination-container"></div>
            </div>
        </div>


    </div>
    {% endif %}


    <div class="admin-section" id="roles">
        <div class="data-table">
            <div class="table-header">
                <h3>Role & Permission Reference</h3>
                <p style="color: #64748b; font-size: 0.9rem; margin: 0;">Manage roles and permissions. Create custom roles or edit existing ones. Assign roles to users in the Users tab.</p>
            </div>
            <div class="table-content">

                <div style="margin-bottom: 2rem; border-bottom: 2px solid #e2e8f0;">
                    <div class="role-tabs" style="display: flex; gap: 1rem;">
                        <button class="role-tab active" onclick="showRoleTab('system-roles')" data-tab="system-roles">
                            <i class="fas fa-shield-alt"></i> All Roles
                        </button>
                        <button class="role-tab" onclick="showRoleTab('permissions')" data-tab="permissions">
                            <i class="fas fa-key"></i> All Permissions
                        </button>
                    </div>
                </div>


                <div class="role-tab-content active" id="system-roles">
                    <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; color: #1e293b;">Available Roles</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            {% if 'system.manage_roles' in user_permissions or current_user.is_admin %}
                            <button onclick="createNewRole()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Role
                            </button>
                            {% endif %}
                            <button onclick="loadRoles()" class="btn btn-secondary">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div id="rolesContainer">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            <i class="fas fa-spinner fa-spin"></i> Loading roles...
                        </p>
                    </div>
                </div>


                <div class="role-tab-content" id="permissions">
                    <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; color: #1e293b;">All Available Permissions</h4>
                        <button onclick="loadPermissions()" class="btn btn-secondary">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div id="permissionsContainer">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            <i class="fas fa-spinner fa-spin"></i> Loading permissions...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="admin-section" id="settings">
        <div class="data-table">
            <div class="table-header">
                <h3>System Settings</h3>
                <p style="color: #64748b; font-size: 0.9rem; margin: 0;">Configure system-wide settings and maintenance options</p>
            </div>
            <div class="table-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 2rem;">

                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: #1e293b;">Maintenance Mode</h4>
                                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">
                                    Show maintenance page to all users except admins
                                </p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="maintenanceMode" onchange="toggleMaintenanceMode()">
                                <label for="maintenanceMode" class="toggle-label">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; border-left: 4px solid #3b82f6;">
                            <p style="margin: 0; color: #475569; font-size: 0.875rem;">
                                <i class="fas fa-info-circle"></i> When enabled, all users except admins will see a maintenance page. Admins can still access the login page and dashboard.
                            </p>
                        </div>
                    </div>


                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: #1e293b;">Economy System</h4>
                                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">
                                    Enable/disable tokens, shop, and project submissions
                                </p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="economyEnabled" onchange="toggleEconomySystem()">
                                <label for="economyEnabled" class="toggle-label">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; border-left: 4px solid #10b981;">
                            <p style="margin: 0; color: #475569; font-size: 0.875rem;">
                                <i class="fas fa-info-circle"></i> When disabled, the shop, token system, and project submissions will be hidden from all users.
                            </p>
                        </div>


                        <div id="adminEconomyOverride" style="margin-top: 1rem; display: none;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <div>
                                    <h5 style="margin: 0; color: #92400e; font-size: 0.9rem;">Enable for Admins?</h5>
                                    <p style="margin: 0.25rem 0 0 0; color: #b45309; font-size: 0.8rem;">
                                        Allow admins to access economy features for testing
                                    </p>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="adminEconomyEnabled" onchange="toggleAdminEconomyOverride()">
                                    <label for="adminEconomyEnabled" class="toggle-label">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: #1e293b;">Club Creation</h4>
                                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">
                                    Allow users to create new clubs
                                </p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="clubCreationEnabled" onchange="toggleClubCreation()">
                                <label for="clubCreationEnabled" class="toggle-label">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; border-left: 4px solid #f59e0b;">
                            <p style="margin: 0; color: #475569; font-size: 0.875rem;">
                                <i class="fas fa-info-circle"></i> When disabled, users will not be able to create new clubs. Existing clubs remain functional.
                            </p>
                        </div>
                    </div>


                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: #1e293b;">User Registration</h4>
                                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">
                                    Allow new users to register accounts
                                </p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="userRegistrationEnabled" onchange="toggleUserRegistration()">
                                <label for="userRegistrationEnabled" class="toggle-label">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; border-left: 4px solid #dc2626;">
                            <p style="margin: 0; color: #475569; font-size: 0.875rem;">
                                <i class="fas fa-info-circle"></i> When disabled, new users cannot register. Existing users can still log in and use the system.
                            </p>
                        </div>
                    </div>


                    <div class="setting-item" style="border-top: 2px solid #e2e8f0; padding-top: 2rem; margin-top: 2rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-bullhorn"></i> Promotional Banner
                                </h4>
                                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">
                                    Display custom promotional banners across the platform
                                </p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="bannerEnabled" onchange="toggleBanner()">
                                <label for="bannerEnabled" class="toggle-label">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>


                        <div id="bannerConfigPanel" style="display: none; background: #f8fafc; border-radius: 12px; padding: 1.5rem; border: 1px solid #e2e8f0; margin-top: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Banner Title</label>
                                    <input type="text" id="bannerTitle" placeholder="Design Contest"
                                           style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;"
                                           onchange="updateBannerPreview()">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Banner Icon (FontAwesome class)</label>
                                    <input type="text" id="bannerIcon" placeholder="fas fa-palette"
                                           style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;"
                                           onchange="updateBannerPreview()">
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Banner Subtitle</label>
                                <textarea id="bannerSubtitle" placeholder="Submit your creative projects and win amazing prizes!"
                                          style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; resize: vertical; min-height: 80px;"
                                          onchange="updateBannerPreview()"></textarea>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">

                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Primary Color</label>
                                    <input type="color" id="bannerPrimaryColor" value="#ec3750"
                                           style="width: 100%; height: 40px; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;"
                                           onchange="updateBannerPreview()">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Secondary Color</label>
                                    <input type="color" id="bannerSecondaryColor" value="#d63146"
                                           style="width: 100%; height: 40px; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;"
                                           onchange="updateBannerPreview()">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Background Color</label>
                                    <input type="color" id="bannerBackgroundColor" value="#ffffff"
                                           style="width: 100%; height: 40px; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;"
                                           onchange="updateBannerPreview()">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Text Color</label>
                                    <input type="color" id="bannerTextColor" value="#1a202c"
                                           style="width: 100%; height: 40px; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;"
                                           onchange="updateBannerPreview()">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 200px; gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Link URL</label>
                                    <input type="text" id="bannerLinkUrl" placeholder="/gallery"
                                           style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;"
                                           onchange="updateBannerPreview()">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Button Text</label>
                                    <input type="text" id="bannerButtonText" placeholder="Submit Entry"
                                           style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;"
                                           onchange="updateBannerPreview()">
                                </div>
                            </div>


                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #374151;">Preview:</label>
                                <div id="bannerPreview" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 1rem; min-height: 120px; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                                    <span style="color: #9ca3af; font-style: italic;">Enable banner to see preview</span>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button onclick="saveBannerSettings()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-save"></i> Save Banner Settings
                                </button>
                                <button onclick="resetBannerSettings()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                            </div>
                        </div>

                        <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; border-left: 4px solid #8b5cf6; margin-top: 1rem;">
                            <p style="margin: 0; color: #475569; font-size: 0.875rem;">
                                <i class="fas fa-info-circle"></i> When enabled, this banner will appear on the dashboard and other key pages. Perfect for contests, announcements, or promotional campaigns.
                            </p>
                        </div>
                    </div>
                </div>


                <div style="padding: 0 2rem 2rem 2rem;">
                    <div style="background: #f1f5f9; border-radius: 8px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #1e293b;">Current Status</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Maintenance Mode:</p>
                                <p style="margin: 0.25rem 0 0 0; font-weight: 600;" id="maintenanceStatus">Loading...</p>
                            </div>
                            <div>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Economy System:</p>
                                <p style="margin: 0.25rem 0 0 0; font-weight: 600;" id="economyStatus">Loading...</p>
                            </div>
                            <div>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Club Creation:</p>
                                <p style="margin: 0.25rem 0 0 0; font-weight: 600;" id="clubCreationStatus">Loading...</p>
                            </div>
                            <div>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">User Registration:</p>
                                <p style="margin: 0.25rem 0 0 0; font-weight: 600;" id="userRegistrationStatus">Loading...</p>
                            </div>
                            <div>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Heidi AI Assistant:</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="userInfoModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>User Information</h3>
            <button class="modal-close" onclick="closeModal('userInfoModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="userInfoContent">
                <div class="loading" id="userInfoLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading user information...</p>
                </div>
                <div id="userInfoDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <div>
                            <h4 style="margin-bottom: 1rem; color: #1e293b;">Basic Information</h4>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                                <p><strong>Username:</strong> <span id="modalUsername"></span></p>
                                <p><strong>Email:</strong> <span id="modalEmail"></span></p>
                                <p><strong>Name:</strong> <span id="modalFullName"></span></p>
                                <p><strong>Role:</strong> <span id="modalRole"></span></p>
                                <p><strong>Status:</strong> <span id="modalStatus"></span></p>
                                <p><strong>Created:</strong> <span id="modalCreated"></span></p>
                                <p><strong>Last Login:</strong> <span id="modalLastLogin"></span></p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 1rem; color: #1e293b;">Security Information</h4>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                                <p><strong>Registration IP:</strong> <code id="modalRegistrationIP"></code></p>
                                <p><strong>Last Login IP:</strong> <code id="modalLastLoginIP"></code></p>
                                <p><strong>Total IP Addresses:</strong> <span id="modalTotalIPs"></span></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 style="margin-bottom: 1rem; color: #1e293b;">IP Address History</h4>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto;">
                            <div id="modalIPHistory">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="closeModal('userInfoModal')" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="editUserModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit User</h3>
            <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="editUsername" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="editFullName">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-control" id="editRole">
                        <option value="user">User</option>
                        <option value="reviewer">Reviewer</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div style="display: flex; gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="editStatus" id="editStatusActive" value="active">
                            Active
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="editStatus" id="editStatusSuspended" value="suspended">
                            Suspended
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="editClubModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Club</h3>
            <button class="modal-close" onclick="closeModal('editClubModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editClubForm">
                <input type="hidden" id="editClubId">
                <div class="form-group">
                    <label class="form-label">Club Name</label>
                    <input type="text" class="form-control" id="editClubName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="editClubDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="editClubLocation">
                </div>
                <div class="form-group">
                    <label class="form-label">Balance (USD)</label>
                    <input type="number" class="form-control" id="editClubBalance" step="0.01">
                    <small class="form-text text-muted">Internal USD value (will display as tokens to users)</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editClubModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveClubChanges()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="createClubModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Club</h3>
            <button class="modal-close" onclick="closeModal('createClubModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="color: #92400e; font-size: 0.875rem;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Important:</strong> This will create a standalone club that is not connected to the official Hack Club directory. To connect to an official club, use the leader verification process instead.
                </div>
            </div>
            <form id="createClubForm">
                <div class="form-group">
                    <label class="form-label">Club Name</label>
                    <input type="text" class="form-control" id="createClubName" placeholder="Enter club name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="createClubDescription" rows="3" placeholder="Enter club description"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="createClubLocation" placeholder="Enter club location">
                </div>
                <div class="form-group">
                    <label class="form-label">Leader Email</label>
                    <input type="email" class="form-control" id="createClubLeaderEmail" placeholder="Enter leader's email" required>
                    <small style="color: #64748b; font-size: 0.875rem;">The user must already have an account.</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Balance (USD)</label>
                    <input type="number" class="form-control" id="createClubBalance" placeholder="0.00" step="0.01" min="0" value="0">
                    <small class="form-text text-muted">Internal USD value (will display as tokens to users)</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createClubModal')">Cancel</button>
            <button class="btn btn-primary" onclick="createNewClub()">Create Club</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="transferLeadershipModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Transfer Club Leadership</h3>
            <button class="modal-close" onclick="closeModal('transferLeadershipModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="color: #0c4a6e; font-size: 0.875rem;">
                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> This will transfer full ownership of the club to the selected user. The current leader will become a regular member.
                </div>
            </div>
            <form id="transferLeadershipForm">
                <div class="form-group">
                    <label class="form-label">Club</label>
                    <input type="text" class="form-control" id="transferClubName" readonly>
                    <input type="hidden" id="transferClubId">
                    <input type="hidden" id="transferCurrentLeaderId">
                </div>
                <div class="form-group">
                    <label class="form-label">Current Leader</label>
                    <input type="text" class="form-control" id="transferCurrentLeader" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">New Leader</label>
                    <div style="position: relative;">
                        <input type="text" class="form-control" id="transferNewLeaderSearch" placeholder="Search for user by username or email..." autocomplete="off">
                        <div id="transferUserSearchResults" class="user-search-dropdown" style="display: none;"></div>
                    </div>
                    <input type="hidden" id="transferNewLeaderId">
                    <small style="color: #64748b; font-size: 0.875rem;">Start typing to search for users. The user must have an account.</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('transferLeadershipModal')">Cancel</button>
            <button class="btn btn-primary" onclick="confirmTransferLeadership()" id="transferLeadershipBtn" disabled>Transfer Leadership</button>
        </div>
    </div>
</div>


<div class="modal-backdrop" id="resetPasswordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reset Password</h3>
            <button class="modal-close" onclick="closeModal('resetPasswordModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Enter new password for <span id="resetPasswordUsername"></span>:</p>
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" class="form-control" id="newPassword" placeholder="Enter new password" minlength="6" required>
                <small style="color: #64748b; font-size: 0.875rem;">Password must be at least 6 characters long.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Cancel</button>
            <button class="btn btn-primary" onclick="executePasswordReset()">Reset Password</button>
        </div>
    </div>
</div>


<div class="modal-backdrop" id="clubTeamNotesModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-sticky-note"></i> Team Notes for <span id="clubTeamNotesName"></span></h3>
            <button class="modal-close" onclick="closeModal('clubTeamNotesModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="clubTeamNotesId">
            <div class="form-group">
                <label class="form-label">Internal Notes</label>
                <textarea id="clubTeamNotesText" rows="10" class="form-control" placeholder="Add internal notes about this club here..." style="font-family: inherit;"></textarea>
                <small style="color: #64748b; font-size: 0.875rem;">
                    <i class="fas fa-info-circle"></i> Use this space for planning, meeting notes, important reminders, or any internal club information. Changes sync to Airtable.
                </small>
            </div>
            <div id="clubTeamNotesStatus"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('clubTeamNotesModal')">Close</button>
            <button class="btn btn-primary" onclick="saveClubTeamNotes()">
                <i class="fas fa-save"></i> Save Team Notes
            </button>
        </div>
    </div>
</div>


<!-- Create Users Modal (Choose Method) -->
<div class="modal-backdrop" id="createUsersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Create Users</h3>
            <button class="modal-close" onclick="closeModal('createUsersModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 1.5rem; color: #64748b;">Choose how you want to create users:</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button class="btn btn-primary" onclick="closeModal('createUsersModal'); openModal('createSingleUserModal')" style="padding: 2rem 1rem; height: auto; display: flex; flex-direction: column; gap: 0.5rem;">
                    <i class="fas fa-user" style="font-size: 2rem;"></i>
                    <span style="font-weight: 600;">Create Single User</span>
                    <small style="opacity: 0.8;">Manually create one user</small>
                </button>
                <button class="btn btn-success" onclick="closeModal('createUsersModal'); openModal('bulkCreateUsersModal')" style="padding: 2rem 1rem; height: auto; display: flex; flex-direction: column; gap: 0.5rem;">
                    <i class="fas fa-file-csv" style="font-size: 2rem;"></i>
                    <span style="font-weight: 600;">Bulk Upload CSV</span>
                    <small style="opacity: 0.8;">Upload multiple users at once</small>
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createUsersModal')">Cancel</button>
        </div>
    </div>
</div>


<!-- Create Single User Modal -->
<div class="modal-backdrop" id="createSingleUserModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user"></i> Create Single User</h3>
            <button class="modal-close" onclick="closeModal('createSingleUserModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createSingleUserForm">
                <div class="form-group">
                    <label class="form-label">Username *</label>
                    <input type="text" class="form-control" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control" id="newEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-control" id="newFirstName">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="newLastName">
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" class="form-control" id="newPassword" required minlength="6">
                    <small style="color: #64748b;">Minimum 6 characters</small>
                </div>
            </form>
            <div id="createUserStatus"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createSingleUserModal')">Cancel</button>
            <button class="btn btn-primary" onclick="createSingleUser()">
                <i class="fas fa-user-plus"></i> Create User
            </button>
        </div>
    </div>
</div>


<!-- Bulk Create Users Modal -->
<div class="modal-backdrop" id="bulkCreateUsersModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-csv"></i> Bulk Create Users from CSV</h3>
            <button class="modal-close" onclick="closeModal('bulkCreateUsersModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #475569;">
                    <i class="fas fa-info-circle"></i> CSV Format
                </h4>
                <p style="margin: 0; font-size: 0.875rem; color: #64748b;">
                    Upload a CSV file with columns: <strong>username, email, first_name, last_name, password</strong><br>
                    First row should be headers. Password column is optional (random password will be generated if not provided).
                </p>
                <button class="btn btn-secondary btn-sm" onclick="downloadCSVTemplate()" style="margin-top: 0.5rem;">
                    <i class="fas fa-download"></i> Download Template
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Upload CSV File</label>
                <input type="file" class="form-control" id="bulkUsersCSV" accept=".csv" onchange="previewCSV()">
            </div>
            
            <div id="csvPreview" style="display: none; margin-top: 1rem;">
                <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Preview (first 5 rows):</h4>
                <div id="csvPreviewContent" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.5rem; font-size: 0.85rem; background: white;"></div>
                <p id="csvRowCount" style="margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;"></p>
            </div>
            
            <div id="bulkCreateStatus" style="margin-top: 1rem;"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('bulkCreateUsersModal')">Cancel</button>
            <button class="btn btn-success" onclick="bulkCreateUsers()" id="bulkCreateBtn" disabled>
                <i class="fas fa-upload"></i> Upload & Create Users
            </button>
        </div>
    </div>
</div>


<div class="modal-backdrop" id="roleUsersModal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3><i class="fas fa-users"></i> Manage Users for Role: <span id="roleUsersRoleName"></span></h3>
            <button class="modal-close" onclick="closeModal('roleUsersModal')">&times;</button>
        </div>
        <div class="modal-body">

            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #16a34a; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-user-plus"></i> Add User to Role
                </h4>
                <div style="display: flex; gap: 1rem; align-items: end;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Search Users</label>
                        <input
                            type="text"
                            id="roleUserSearch"
                            placeholder="Type username or email..."
                            style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;"
                            oninput="searchUsersForRole()"
                        >
                    </div>
                    <button
                        onclick="clearRoleUserSearch()"
                        class="btn btn-secondary"
                        style="padding: 0.75rem 1.5rem;"
                    >
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                <div id="roleUserSearchResults" style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                    <p style="color: #64748b; text-align: center; padding: 1rem;">
                        <i class="fas fa-search"></i> Search for users to add to this role
                    </p>
                </div>
            </div>


            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; display: flex; align-items: center; justify-content: space-between;">
                    <span><i class="fas fa-users"></i> Assigned Users (<span id="roleUsersCount">0</span>)</span>
                    <button onclick="refreshRoleUsers()" class="btn btn-secondary btn-sm" style="padding: 0.5rem 1rem;">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </h4>
                <div id="roleUsersList" style="max-height: 400px; overflow-y: auto;">
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Loading users...
                    </p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('roleUsersModal')">Close</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="reviewDetailsModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>Project Grant Submission Details</h3>
            <button class="modal-close" onclick="closeModal('reviewDetailsModal')">&times;</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div id="reviewDetailsContent">

            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('reviewDetailsModal')">Close</button>
            <button class="btn btn-success" id="approveButton" onclick="approveSubmission()" style="display: none;">
                <i class="fas fa-check"></i> Approve Grant
            </button>
            <button class="btn btn-danger" id="rejectButton" onclick="rejectSubmission()" style="display: none;">
                <i class="fas fa-times"></i> Reject Grant
            </button>
        </div>
    </div>
</div>

<script>
// User Permissions (from backend)
window.canManageRoles = {{ 'true' if can_manage_users else 'false' }};
window.canEditUsers = {{ 'true' if 'users.edit' in user_permissions or current_user.is_admin else 'false' }};
window.canDeleteUsers = {{ 'true' if 'users.delete' in user_permissions or current_user.is_admin else 'false' }};
window.canSuspendUsers = {{ 'true' if 'users.suspend' in user_permissions or current_user.is_admin else 'false' }};
window.canImpersonate = {{ 'true' if 'users.impersonate' in user_permissions or current_user.is_admin else 'false' }};
window.canManage2FA = {{ 'true' if 'users.manage_2fa' in user_permissions or current_user.is_admin else 'false' }};
window.canViewUsers = {{ 'true' if can_view_users else 'false' }};
window.canViewClubs = {{ 'true' if can_view_clubs else 'false' }};
window.canViewContent = {{ 'true' if can_view_content else 'false' }};
window.canManageSettings = {{ 'true' if can_manage_settings else 'false' }};
window.canViewActivity = {{ 'true' if can_view_activity else 'false' }};
window.canEditClubs = {{ 'true' if 'clubs.edit' in user_permissions or current_user.is_admin else 'false' }};
window.canDeleteClubs = {{ 'true' if 'clubs.delete' in user_permissions or current_user.is_admin else 'false' }};
window.canSuspendClubs = {{ 'true' if 'clubs.suspend' in user_permissions or current_user.is_admin else 'false' }};
window.canTransferClubLeadership = {{ 'true' if 'clubs.edit' in user_permissions or current_user.is_admin else 'false' }};
window.canManageSyncImmune = {{ 'true' if 'clubs.edit' in user_permissions or current_user.is_admin else 'false' }};

/* ============================================
   ADMIN DASHBOARD v2.1 - 2025-11-02 22:52
   Fixed: Consolidated showAdminSection
   Cache Buster: Please hard refresh (Ctrl+Shift+R)
   ============================================ */

// Global dropdown menu element - declare at top to avoid initialization errors
let globalDropdownMenu = null;

// CSRF Token functions
function getCSRFToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : null;
}

function makeSecureRequest(url, options = {}) {
    const csrfToken = getCSRFToken();

    // Default options
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json'
        }
    };

    // Add CSRF token to headers if available and method is not GET
    if (csrfToken && options.method && options.method !== 'GET') {
        defaultOptions.headers['X-CSRFToken'] = csrfToken;
    }

    // Merge options
    const finalOptions = {
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...(options.headers || {})
        }
    };

    return fetch(url, finalOptions);
}

let usersData = [];
let clubsData = [];
let adminsData = [];
let reviewData = [];
let currentSubmissionId = null;
let currentAction = { type: null, data: null };
let projectGrantSubmissions = [];
let currentLoginAsUserId = null;
let currentResetPasswordUserId = null;
let currentSuspendUserId = null;
let currentSuspendUsername = null;
let isClubLeader = false;

// Pagination variables
let currentUsersPage = 1;
let currentClubsPage = 1;
let usersPerPage = 10;
let clubsPerPage = 10;
let totalUsers = 0;
let totalClubs = 0;
let filteredUsersData = [];
let filteredClubsData = [];

function showAdminSection(section) {
    // Hide all sections
    document.querySelectorAll('.admin-section').forEach(sec => {
        sec.style.display = 'none';
    });

    // Remove active class from all tabs
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show the selected section
    const selectedSection = document.getElementById(section);
    if (selectedSection) {
        selectedSection.style.display = 'block';
    }

    // Add active class to the clicked tab
    const activeTab = document.querySelector(`.admin-tab[data-section="${section}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
    }

    // Permission checks for each section
    if (section === 'users' && !window.canViewUsers) {
        showToast('error', 'Access denied: You do not have permission to view users');
        showAdminSection('overview');
        return;
    } else if (section === 'clubs' && !window.canViewClubs) {
        showToast('error', 'Access denied: You do not have permission to view clubs');
        showAdminSection('overview');
        return;
    } else if (section === 'activity' && !window.canViewActivity) {
        showToast('error', 'Access denied: You do not have permission to view activity');
        showAdminSection('overview');
        return;
    } else if (section === 'roles' && !window.canManageRoles) {
        showToast('error', 'Access denied: You do not have permission to manage roles');
        showAdminSection('overview');
        return;
    } else if (section === 'api' && !window.canAccessApi) {
        showToast('error', 'Access denied: You do not have permission to access API management');
        showAdminSection('overview');
        return;
    } else if (section === 'settings' && !window.canManageSettings) {
        showToast('error', 'Access denied: You do not have permission to manage settings');
        showAdminSection('overview');
        return;
    }

    // Load data if needed
    if (section === 'users') {
        loadRecentUsers();
    } else if (section === 'clubs') {
        loadRecentClubs();
    } else if (section === 'activity') {
        loadLogs();
    } else if (section === 'review') {
        loadProjectGrantSubmissions();
    }
}

// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Show overview section by default
    showAdminSection('overview');
});

async function loadRecentUsers() {
    try {
        const usersTableBody = document.getElementById('usersTableBody');
        usersTableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="mt-2">Loading recent users...</p>
                </td>
            </tr>`;

        const response = await fetch('/admin/users/recent');
        const data = await response.json();

        if (response.ok) {
            const users = data.results || [];
            usersData = users;
            renderUsersTable(users);
        } else {
            throw new Error(data.error || 'Failed to load users');
        }
    } catch (error) {
        console.error('Error loading recent users:', error);
        const usersTableBody = document.getElementById('usersTableBody');
        usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">Failed to load users. Please try searching.</td></tr>';
    }
}

let currentUserView = 'normal';
let currentGroupPage = 1;
const groupsPerPage = 4;

function setUserView(viewType) {
    currentUserView = viewType;

    // Update button states
    document.querySelectorAll('.user-view-controls .btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(viewType === 'normal' ? 'normalViewBtn' :
                           viewType === 'group-ip' ? 'groupIpBtn' : 'groupClubBtn').classList.add('active');

    // Show/hide appropriate views
    const normalView = document.getElementById('usersTable');
    const ipView = document.getElementById('groupByIpView');
    const clubView = document.getElementById('groupByClubView');

    // Hide all views first
    if (normalView) normalView.style.display = 'none';
    if (ipView) ipView.style.display = 'none';
    if (clubView) clubView.style.display = 'none';

    // Show appropriate view and load data
    switch (viewType) {
        case 'normal':
            if (normalView) normalView.style.display = 'table';
            loadRecentUsers();
            break;
        case 'group-ip':
            if (ipView) ipView.style.display = 'block';
            loadUsersByIP();
            break;
        case 'group-club':
            if (clubView) clubView.style.display = 'block';
            loadUsersByClub();
            break;
    }
}

// Sorting removed - search only mode

async function loadUsersByIP(page = 1, sort = 'users-desc') {
    try {
        const container = document.getElementById('ipGroupsContainer');
        const infoSpan = document.getElementById('ipGroupsInfo');
        container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading IP groups...</p></div>';
        infoSpan.textContent = 'Loading...';

        const response = await fetch(`/api/admin/users/group-by-ip?page=${page}&per_page=${groupsPerPage}&sort=${sort}`);
        const data = await response.json();

        if (response.ok) {
            renderIPGroups(data);
            infoSpan.textContent = `${data.total_groups} IP groups, ${data.total_users_with_ips} users`;
        } else {
            throw new Error(data.error || 'Failed to load IP groups');
        }
    } catch (error) {
        console.error('Error loading IP groups:', error);
        showToast('error', 'Failed to load IP groups. Please try again.');
        document.getElementById('ipGroupsInfo').textContent = 'Error loading groups';
    }
}

async function loadUsersByClub(page = 1, sort = 'users-desc') {
    try {
        const container = document.getElementById('clubGroupsContainer');
        const infoSpan = document.getElementById('clubGroupsInfo');
        container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading club groups...</p></div>';
        infoSpan.textContent = 'Loading...';

        const response = await fetch(`/api/admin/users/group-by-club?page=${page}&per_page=${groupsPerPage}&sort=${sort}`);
        const data = await response.json();

        if (response.ok) {
            renderClubGroups(data);
            infoSpan.textContent = `${data.total_clubs} clubs, ${data.total_users_in_clubs} users in clubs, ${data.users_without_clubs_count} users without clubs`;
        } else {
            throw new Error(data.error || 'Failed to load club groups');
        }
    } catch (error) {
        console.error('Error loading club groups:', error);
        showToast('error', 'Failed to load club groups. Please try again.');
        document.getElementById('clubGroupsInfo').textContent = 'Error loading groups';
    }
}

function sortAndPaginateGroups(groupType) {
    const sortSelect = document.getElementById(groupType === 'ip' ? 'ipSortSelect' : 'clubSortSelect');
    const sortValue = sortSelect.value;

    // Reset to page 1 when sorting changes
    currentGroupPage = 1;

    // Load data with new sorting
    if (groupType === 'ip') {
        loadUsersByIP(currentGroupPage, sortValue);
    } else {
        loadUsersByClub(currentGroupPage, sortValue);
    }
}

function renderIPGroups(data) {
    const container = document.getElementById('ipGroupsContainer');

    if (!data.groups || data.groups.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-network-wired"></i><p>No IP groups found</p></div>';
        document.getElementById('ipGroupsPagination').innerHTML = '';
        return;
    }

    const html = data.groups.map(group => `
        <div class="user-group">
            <div class="group-header" onclick="toggleGroup(this)">
                <div class="group-title">
                    <i class="fas fa-network-wired"></i>
                    IP: ${group.ip}
                    <span style="font-size: 0.9em; color: #6b7280; margin-left: 0.5rem;">(${group.type})</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="group-count">${group.users.length} users</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
            </div>
            <div class="group-content">
                ${group.users.map(user => `
                    <div class="user-mini-card">
                        <div class="user-mini-info">
                            <div class="user-mini-name">${escapeHtml(user.username)}</div>
                            <div class="user-mini-email">${escapeHtml(user.email)}</div>
                        </div>
                        <div class="user-mini-meta">
                            ${user.is_admin ? '<span class="badge badge-admin">Admin</span>' : ''}
                            ${user.is_reviewer ? '<span class="badge badge-reviewer">Reviewer</span>' : ''}
                            ${user.is_suspended ? '<span class="badge badge-suspended">Suspended</span>' : ''}
                            <span>${user.clubs_led} clubs led</span>
                            <span>${user.clubs_joined} clubs joined</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
    currentGroupPage = data.page;
    renderGroupPagination('ip', data.page, data.total_pages, data.total_groups);
}

function renderClubGroups(data) {
    const container = document.getElementById('clubGroupsContainer');

    if (!data.groups || data.groups.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No club groups found</p></div>';
        document.getElementById('clubGroupsPagination').innerHTML = '';
        return;
    }

    const html = data.groups.map(group => `
        <div class="user-group">
            <div class="group-header" onclick="toggleGroup(this)">
                <div class="group-title">
                    ${group.isSpecial ? '<i class="fas fa-user-slash"></i>' : '<i class="fas fa-users"></i>'}
                    ${escapeHtml(group.club_name)}
                    ${!group.isSpecial && group.club_code ? `<span style="font-size: 0.9em; color: #6b7280; margin-left: 0.5rem;">(Code: ${group.club_code})</span>` : ''}
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="group-count">${group.total_users} users</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
            </div>
            <div class="group-content">
                ${group.users.map(user => `
                    <div class="user-mini-card">
                        <div class="user-mini-info">
                            <div class="user-mini-name">
                                ${escapeHtml(user.username)}
                                ${user.role === 'Leader' ? '<i class="fas fa-crown" style="color: #f59e0b; margin-left: 0.5rem;" title="Club Leader"></i>' : ''}
                            </div>
                            <div class="user-mini-email">${escapeHtml(user.email)}</div>
                        </div>
                        <div class="user-mini-meta">
                            <span class="badge badge-role">${user.role}</span>
                            ${user.is_admin ? '<span class="badge badge-admin">Admin</span>' : ''}
                            ${user.is_reviewer ? '<span class="badge badge-reviewer">Reviewer</span>' : ''}
                            ${user.is_suspended ? '<span class="badge badge-suspended">Suspended</span>' : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
    currentGroupPage = data.page;
    renderGroupPagination('club', data.page, data.total_pages, data.total_groups);
}

function renderGroupPagination(groupType, currentPage, totalPages, totalGroups) {
    const paginationContainer = document.getElementById(groupType + 'GroupsPagination');

    if (totalPages <= 1) {
        paginationContainer.innerHTML = totalGroups > 0 ? `
            <div class="pagination-info">
                Showing ${totalGroups} group${totalGroups !== 1 ? 's' : ''}
            </div>
        ` : '';
        return;
    }

    const startItem = ((currentPage - 1) * groupsPerPage) + 1;
    const endItem = Math.min(currentPage * groupsPerPage, totalGroups);

    let html = `
        <div class="pagination">
            <div class="pagination-info">
                Showing ${startItem} to ${endItem} of ${totalGroups} groups
            </div>

            <div class="pagination-buttons">
                <button class="pagination-btn" onclick="goToGroupPage('${groupType}', 1)" ${currentPage === 1 ? 'disabled' : ''}>
                    &laquo; First
                </button>
                <button class="pagination-btn" onclick="goToGroupPage('${groupType}', ${Math.max(1, currentPage - 1)})" ${currentPage === 1 ? 'disabled' : ''}>
                    &lsaquo; Previous
                </button>

                ${generateGroupPageNumbers(currentPage, totalPages, groupType)}

                <button class="pagination-btn" onclick="goToGroupPage('${groupType}', ${Math.min(totalPages, currentPage + 1)})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Next &rsaquo;
                </button>
                <button class="pagination-btn" onclick="goToGroupPage('${groupType}', ${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Last &raquo;
                </button>
            </div>
        </div>
    `;

    paginationContainer.innerHTML = html;
}

function generateGroupPageNumbers(currentPage, totalPages, groupType) {
    let html = '';
    const maxVisible = 5;

    let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let end = Math.min(totalPages, start + maxVisible - 1);

    if (end - start + 1 < maxVisible) {
        start = Math.max(1, end - maxVisible + 1);
    }

    for (let i = start; i <= end; i++) {
        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToGroupPage('${groupType}', ${i})">${i}</button>`;
    }

    return html;
}

function goToGroupPage(groupType, page) {
    const sortSelect = document.getElementById(groupType === 'ip' ? 'ipSortSelect' : 'clubSortSelect');
    const sortValue = sortSelect.value;

    if (groupType === 'ip') {
        loadUsersByIP(page, sortValue);
    } else {
        loadUsersByClub(page, sortValue);
    }
}

function toggleGroup(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.collapse-icon');

    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        icon.classList.remove('collapsed');
    } else {
        content.classList.add('collapsed');
        icon.classList.add('collapsed');
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function loadRecentClubs() {
    try {
        const clubsTableBody = document.getElementById('clubsTableBody');
        clubsTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="mt-2">Loading recent clubs...</p>
                </td>
            </tr>`;

        const response = await fetch('/admin/clubs/recent');
        const data = await response.json();

        if (response.ok) {
            const clubs = data.results || [];
            clubsData = clubs;
            renderClubsTable(clubs);
        } else {
            throw new Error(data.error || 'Failed to load clubs');
        }
    } catch (error) {
        console.error('Error loading recent clubs:', error);
        const clubsTableBody = document.getElementById('clubsTableBody');
        clubsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b; padding: 2rem;">Failed to load clubs. Please try searching.</td></tr>';
    }
}

function renderUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    const table = document.getElementById('usersTable');
    const loading = document.getElementById('usersLoading');

    tbody.innerHTML = '';

    // Hide loading and show table
    loading.style.display = 'none';
    table.style.display = 'table';

    // Debug logging
    console.log('[DEBUG] Rendering users, canManage2FA:', window.canManage2FA);
    console.log('[DEBUG] First user data sample:', users[0]);

    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">No users found</td></tr>';
        return;
    }

    // Fetch all users with their roles for display
    Promise.all(users.map(user =>
        makeSecureRequest(`/api/admin/rbac/users/${user.id}/roles`)
            .then(r => r.json())
            .catch(() => ({ roles: [], is_root: false }))
    )).then(userRolesData => {
        users.forEach((user, index) => {
            const userData = userRolesData[index];
            const isRoot = userData.is_root || false;
            const roles = userData.roles || [];

            const row = document.createElement('tr');
            
            // Debug for 2FA button
            if (user.username === 'Ethan' || user.totp_enabled) {
                console.log(`[DEBUG] User: ${user.username}, totp_enabled:`, user.totp_enabled, 'type:', typeof user.totp_enabled);
            }
            
            row.innerHTML = `
                <td>
                    <strong>${user.username}</strong>
                    ${isRoot ? '<i class="fas fa-crown" style="color: #fbbf24; margin-left: 0.5rem;" title="Root User"></i>' : ''}
                    ${user.totp_enabled ? '<i class="fas fa-shield-alt" style="color: #10b981; margin-left: 0.5rem;" title="2FA Enabled"></i>' : ''}
                </td>
                <td>${user.email}</td>
                <td>
                    ${roles.length > 0 ?
                        roles.map(role => `<span class="status-badge ${
                            role.name === 'super-admin' ? 'status-admin' :
                            role.name === 'admin' ? 'status-admin' :
                            role.name === 'reviewer' ? 'status-reviewer' :
                            'status-user'
                        }" style="margin: 0.15rem; display: inline-block;">${role.display_name}</span>`).join('')
                        : '<span class="status-badge status-user">No Roles</span>'}
                </td>
                <td>
                    <span class="status-badge ${user.is_suspended ? 'status-suspended' : 'status-active'}">
                        ${user.is_suspended ? 'Suspended' : 'Active'}
                    </span>
                </td>
                <td>${user.clubs_led + user.clubs_joined} clubs</td>
                <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown'}</td>
                <td>
                    <div class="action-dropdown">
                        <button class="dropdown-toggle" onclick="toggleDropdown(this)">
                            <i class="fas fa-cog"></i> Actions <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <button class="dropdown-item info" onclick="viewUserInfo(${user.id}); closeDropdown(this)">
                                <i class="fas fa-info-circle"></i> User Info
                            </button>
                            ${window.canManageRoles ? `
                            <button class="dropdown-item primary" onclick="manageUserRoles(${user.id}, '${escapeHtml(user.username).replace(/'/g, '\\\'').replace(/"/g, '\\"')}', ${isRoot}); closeDropdown(this)">
                                <i class="fas fa-user-shield"></i> Manage Roles
                            </button>` : ''}
                            ${window.canEditUsers ? `
                            <button class="dropdown-item edit" onclick="editUser(${user.id}); closeDropdown(this)">
                                <i class="fas fa-edit"></i> Edit User
                            </button>` : ''}
                            ${window.canImpersonate ? `
                            <button class="dropdown-item login" onclick="loginAsUser(${user.id}, '${escapeHtml(user.username).replace(/'/g, '\\\'').replace(/"/g, '\\"')}'); closeDropdown(this)">
                                <i class="fas fa-sign-in-alt"></i> Login as User
                            </button>` : ''}
                            ${window.canEditUsers ? `
                            <button class="dropdown-item reset" onclick="event.stopPropagation(); resetUserPassword(${user.id}, '${escapeHtml(user.username).replace(/'/g, '\\\'').replace(/"/g, '\\"')}'); closeDropdown(this); return false;">
                                <i class="fas fa-key"></i> Reset Password
                            </button>` : ''}
                            ${window.canManage2FA ? `
                            <button class="dropdown-item ${user.totp_enabled ? 'warning' : 'disabled'}" 
                                    onclick="${user.totp_enabled ? `event.stopPropagation(); remove2FA(${user.id}, '${escapeHtml(user.username).replace(/'/g, '\\\'').replace(/"/g, '\\"')}'); closeDropdown(this); return false;` : 'event.preventDefault();'}" 
                                    ${!user.totp_enabled ? 'style="opacity: 0.5; cursor: not-allowed;" title="User does not have 2FA enabled"' : ''}>
                                <i class="fas fa-shield-alt"></i> Remove 2FA ${user.totp_enabled ? '' : '(Not Enabled)'}
                            </button>` : ''}
                            ${window.canSuspendUsers ? `
                            <button class="dropdown-item suspend" onclick="event.stopPropagation(); suspendUser(${user.id}, '${escapeHtml(user.username).replace(/'/g, '\\\'').replace(/"/g, '\\"')}', ${user.clubs_led > 0}); closeDropdown(this); return false;">
                                <i class="fas fa-ban"></i> ${user.is_suspended ? 'Unsuspend User' : 'Suspend User'}
                            </button>` : ''}
                            ${window.canDeleteUsers ? `
                            <button class="dropdown-item danger" onclick="event.stopPropagation(); deleteUser(${user.id}, '${escapeHtml(user.username).replace(/'/g, '\\\'').replace(/"/g, '\\"')}'); closeDropdown(this); return false;">
                                <i class="fas fa-trash"></i> Delete User
                            </button>` : ''}
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    });
}

function renderClubsTable(clubs) {
    const tbody = document.getElementById('clubsTableBody');
    const table = document.getElementById('clubsTable');
    const loading = document.getElementById('clubsLoading');

    tbody.innerHTML = '';

    // Hide loading and show table
    loading.style.display = 'none';
    table.style.display = 'table';

    if (!clubs || clubs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">No clubs found</td></tr>';
        return;
    }

    clubs.forEach(club => {
        const row = document.createElement('tr');
        const isAirtableOnly = club.is_airtable_only === true;

        // Apply greyed out style for non-onboarded clubs
        if (isAirtableOnly) {
            row.style.opacity = '0.6';
            row.style.background = '#f8fafc';
            row.title = 'This club exists in Airtable but is not onboarded to the dashboard';
        }

        // Prepare club data with N/A for missing values
        const displayLeader = isAirtableOnly ? '<em style="color: #94a3b8;">N/A</em>' : `${club.leader} (${club.leader_email})`;
        const displayMembers = isAirtableOnly ? '<em style="color: #94a3b8;">N/A</em>' : `${club.member_count} members`;
        const displayTokens = isAirtableOnly ? '<em style="color: #94a3b8;">N/A</em>' : `${Math.round(club.balance * 100)} tokens`;
        const displayDate = isAirtableOnly ? '<em style="color: #94a3b8;">N/A</em>' : (club.created_at ? new Date(club.created_at).toLocaleDateString() : 'Unknown');

        row.innerHTML = `
            <td>
                <strong>${club.name}</strong>
                ${isAirtableOnly ? ' <span class="status-badge status-warning" style="font-size: 0.7rem; margin-left: 0.5rem;">Not Onboarded</span>' : ''}
            </td>
            <td>${displayLeader}</td>
            <td>${displayMembers}</td>
            <td>${club.location || '<em style="color: #94a3b8;">Not specified</em>'}</td>
            <td>${displayTokens}</td>
            <td>${displayDate}</td>
            <td>
                ${isAirtableOnly ? `
                    <button class="btn ${club.is_suspended ? 'btn-success' : 'btn-warning'} btn-sm"
                            onclick="suspendAirtableClub('${club.airtable_id}', '${escapeHtml(club.name).replace(/'/g, '\\\'').replace(/"/g, '\\"')}', ${!club.is_suspended})"
                            style="padding: 0.4rem 0.8rem;">
                        <i class="fas fa-${club.is_suspended ? 'check' : 'ban'}"></i> ${club.is_suspended ? 'Unsuspend' : 'Suspend'}
                    </button>
                ` : `
                    <div class="action-dropdown">
                        <button class="dropdown-toggle" onclick="toggleDropdown(this)">
                            <i class="fas fa-cog"></i> Actions <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <button class="dropdown-item" onclick="viewClub(${club.id}); closeDropdown(this)">
                                <i class="fas fa-eye"></i> View Club
                            </button>
                            ${window.canEditClubs ? `
                            <button class="dropdown-item edit" onclick="editClub(${club.id}); closeDropdown(this)">
                                <i class="fas fa-edit"></i> Edit Club
                            </button>` : ''}
                            <button class="dropdown-item" onclick="event.stopPropagation(); openClubTeamNotesModal(${club.id}, '${escapeHtml(club.name).replace(/'/g, '\\\'').replace(/"/g, '\\"')}'); closeDropdown(this); return false;">
                                <i class="fas fa-sticky-note"></i> View Team Notes
                            </button>
                            ${window.canSuspendClubs ? `
                            <button class="dropdown-item ${club.is_suspended ? 'success' : 'warning'}" onclick="event.stopPropagation(); suspendDashboardClub(${club.id}, '${escapeHtml(club.name).replace(/'/g, '\\\'').replace(/"/g, '\\"')}', ${!club.is_suspended}, '${club.airtable_id || ''}'); closeDropdown(this); return false;">
                                <i class="fas fa-${club.is_suspended ? 'check' : 'ban'}"></i> ${club.is_suspended ? 'Unsuspend' : 'Suspend'} Club
                            </button>` : ''}
                            ${window.canTransferClubLeadership ? `
                            <button class="dropdown-item transfer" onclick="event.stopPropagation(); openTransferLeadershipModal(${club.id}, '${escapeHtml(club.name).replace(/'/g, '\\\'').replace(/"/g, '\\"')}', ${club.leader_id ?? 'null'}); closeDropdown(this); return false;">
                                <i class="fas fa-exchange-alt"></i> Transfer Leadership
                            </button>` : ''}
                            ${window.canManageSyncImmune ? `
                            <button class="dropdown-item" onclick="event.stopPropagation(); toggleSyncImmune(${club.id}, '${escapeHtml(club.name).replace(/'/g, '\\\'').replace(/"/g, '\\"')}', ${club.sync_immune ?? false}); closeDropdown(this); return false;">
                                <i class="fas fa-shield-alt"></i> ${club.sync_immune ? 'Disable' : 'Enable'} Sync Immune
                            </button>` : ''}
                            ${window.canDeleteClubs ? `
                            <button class="dropdown-item danger" onclick="event.stopPropagation(); deleteClub(${club.id}, '${escapeHtml(club.name).replace(/'/g, '\\\'').replace(/"/g, '\\"')}'); closeDropdown(this); return false;">
                                <i class="fas fa-trash"></i> Delete Club
                            </button>` : ''}
                        </div>
                    </div>
                `}
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Suspend non-onboarded club
async function suspendAirtableClub(airtableId, clubName, suspended) {
    const action = suspended ? 'suspend' : 'unsuspend';

    const confirmed = confirm(`Are you sure you want to ${action} the club "${clubName}"?\n\nThis club exists in Airtable but is not onboarded to the dashboard.`);

    if (!confirmed) return;

    try {
        const response = await makeSecureRequest('/api/admin/clubs/suspend', {
            method: 'POST',
            body: JSON.stringify({
                airtable_id: airtableId,
                suspended: suspended,
                is_airtable_only: true,
                club_name: clubName
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast('success', data.message);
            // Reload clubs to reflect changes
            handleClubSearch(document.getElementById('clubSearch').value);
        } else {
            showToast('error', data.error || `Failed to ${action} club`);
        }
    } catch (error) {
        console.error('Error suspending Airtable club:', error);
        showToast('error', `Error: ${error.message}`);
    }
}

// Suspend dashboard club
async function suspendDashboardClub(clubId, clubName, suspended, airtableId) {
    const action = suspended ? 'suspend' : 'unsuspend';

    const confirmed = confirm(`Are you sure you want to ${action} the club "${clubName}"?`);

    if (!confirmed) return;

    try {
        const response = await makeSecureRequest('/api/admin/clubs/suspend', {
            method: 'POST',
            body: JSON.stringify({
                club_id: clubId,
                airtable_id: airtableId || null,
                suspended: suspended,
                is_airtable_only: false,
                club_name: clubName
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast('success', data.message);
            // Reload clubs to reflect changes
            handleClubSearch(document.getElementById('clubSearch').value);
        } else {
            showToast('error', data.error || `Failed to ${action} club`);
        }
    } catch (error) {
        console.error('Error suspending club:', error);
        showToast('error', `Error: ${error.message}`);
    }
}

// Pagination removed - search only mode

// Pagination removed - search only mode

function generatePageNumbers(currentPage, totalPages, functionName) {
    let html = '';
    const maxVisible = 5;
    let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let end = Math.min(totalPages, start + maxVisible - 1);

    if (end - start + 1 < maxVisible) {
        start = Math.max(1, end - maxVisible + 1);
    }

    for (let i = start; i <= end; i++) {
        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="${functionName}(${i})">${i}</button>`;
    }

    return html;
}

// Page size functions removed - search only mode

// Debounce function to limit API calls during search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Search users with debounce
const handleUserSearch = debounce(async function(searchTerm) {
    if (searchTerm === '') {
        // Clear search results and show message
        const usersTableBody = document.getElementById('usersTableBody');
        usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">Enter a search term to find users</td></tr>';
        return;
    }

    try {
        const usersTableBody = document.getElementById('usersTableBody');
        usersTableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="mt-2">Searching users...</p>
                </td>
            </tr>`;

        const response = await fetch(`/admin/search/users?q=${encodeURIComponent(searchTerm)}`);
        const data = await response.json();

        if (response.ok) {
            const users = data.results || [];
            usersData = users;
            renderUsersTable(users);
        } else {
            throw new Error(data.error || 'Search failed');
        }
    } catch (error) {
        console.error('Error searching users:', error);
        showToast('error', 'Failed to search users. Please try again.');
    }
}, 300);

// Add event listener for user search
document.addEventListener('DOMContentLoaded', function() {
    const userSearch = document.getElementById('userSearch');
    if (userSearch) {
        userSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.trim();
            handleUserSearch(searchTerm);
        });
    }
});

// Search clubs with debounce
const handleClubSearch = debounce(async function(searchTerm) {
    if (searchTerm === '') {
        // Clear search results and show message
        const clubsTableBody = document.getElementById('clubsTableBody');
        clubsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">Enter a search term to find clubs</td></tr>';
        return;
    }

    try {
        const clubsTableBody = document.getElementById('clubsTableBody');
        const includeAirtable = document.getElementById('includeAirtableToggle').checked;

        // Show initial loading state
        clubsTableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="mt-2">Searching onboarded clubs...</p>
                </td>
            </tr>`;

        // First, load dashboard clubs (fast)
        const dashboardResponse = await fetch(`/admin/search/clubs?q=${encodeURIComponent(searchTerm)}&include_airtable=false`);
        const dashboardData = await dashboardResponse.json();

        if (dashboardResponse.ok) {
            const dashboardClubs = dashboardData.results || [];
            clubsData = dashboardClubs;

            // Render dashboard clubs immediately
            renderClubsTable(dashboardClubs);

            // If toggle is on, fetch Airtable clubs as well
            if (includeAirtable) {
                // Add loading indicator for non-onboarded clubs at the end of the table
                const loadingRow = document.createElement('tr');
                loadingRow.id = 'airtable-loading-row';
                loadingRow.innerHTML = `
                    <td colspan="7" class="text-center py-3" style="background: #f8fafc; border-top: 2px solid #e2e8f0;">
                        <div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
                        <p class="mt-2" style="font-size: 0.9rem; color: #64748b;">Loading non-onboarded clubs...</p>
                    </td>
                `;
                clubsTableBody.appendChild(loadingRow);

                // Fetch Airtable clubs
                const airtableResponse = await fetch(`/admin/search/clubs?q=${encodeURIComponent(searchTerm)}&include_airtable=true`);
                const airtableData = await airtableResponse.json();

                if (airtableResponse.ok) {
                    // Remove loading row
                    const loadingRowElement = document.getElementById('airtable-loading-row');
                    if (loadingRowElement) {
                        loadingRowElement.remove();
                    }

                    // Get only the Airtable clubs (filter out dashboard clubs)
                    const allClubs = airtableData.results || [];
                    const airtableOnlyClubs = allClubs.filter(club => club.is_airtable_only);

                    // Combine and re-render
                    const combinedClubs = [...dashboardClubs, ...airtableOnlyClubs];
                    clubsData = combinedClubs;
                    renderClubsTable(combinedClubs);
                } else {
                    // Remove loading row on error
                    const loadingRowElement = document.getElementById('airtable-loading-row');
                    if (loadingRowElement) {
                        loadingRowElement.remove();
                    }
                    showToast('warning', 'Could not load non-onboarded clubs');
                }
            }
        } else {
            throw new Error(dashboardData.error || 'Search failed');
        }
    } catch (error) {
        console.error('Error searching clubs:', error);
        showToast('error', 'Failed to search clubs. Please try again.');
    }
}, 300);

// Add event listener for club search
document.addEventListener('DOMContentLoaded', function() {
    const clubSearch = document.getElementById('clubSearch');
    if (clubSearch) {
        clubSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.trim();
            handleClubSearch(searchTerm);
        });
    }
});

const adminSearchElement = document.getElementById('adminSearch');
if (adminSearchElement) {
    adminSearchElement.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredAdmins = adminsData.filter(admin =>
            admin.username.toLowerCase().includes(searchTerm) ||
            admin.email.toLowerCase().includes(searchTerm)
        );
        renderAdminsTable(filteredAdmins);
    });
}

let pendingAction = null;
let pendingUserId = null;
let pendingUsername = null;
let pendingSubmissionId = null;
let pendingProjectName = null;

function loginAsUser(userId, username) {
    UniversalModal.confirm(
        `Are you sure you want to login as <strong>${username}</strong>?<br><span style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem; display: block;">You will be logged in as this user and can perform actions on their behalf. This action is logged.</span>`,
        async function() {
            // User confirmed
            try {
                const response = await makeSecureRequest(`/api/admin/login-as-user/${userId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showToast('success', `Logging in as ${username}...`);
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000);
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to login as user');
                }
            } catch (error) {
                console.error('Error logging in as user:', error);
                showToast('error', 'Failed to login as user');
            }
        },
        null,
        'Login As User'
    );
}

function resetUserPassword(userId, username) {
    document.getElementById('resetPasswordUsername').textContent = username;
    document.getElementById('newPassword').value = '';
    pendingUserId = userId;
    pendingUsername = username;
    openModal('resetPasswordModal');
}

async function executePasswordReset() {
    const newPassword = document.getElementById('newPassword').value;

    if (!newPassword || newPassword.length < 6) {
        showToast('error', 'Password must be at least 6 characters long');
        return;
    }

    try {
        const response = await makeSecureRequest(`/api/admin/reset-password/${pendingUserId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                new_password: newPassword
            })
        });

        if (response.ok) {
            showToast('success', `Password reset successfully for ${pendingUsername}`);
            closeModal('resetPasswordModal');
        } else {
            const error = await response.json();
            showToast('error', error.error || 'Failed to reset password');
        }
    } catch (error) {
        showToast('error', 'Failed to reset password');
    }
}

function editUser(userId) {
    const user = usersData.find(u => u.id === userId);
    if (!user) return;

    // Populate the edit form with user data
    document.getElementById('editUserId').value = user.id;
    document.getElementById('editUsername').value = user.username;
    document.getElementById('editEmail').value = user.email;

    // Construct full name from first_name and last_name
    const fullName = [user.first_name || '', user.last_name || ''].filter(n => n).join(' ');
    document.getElementById('editFullName').value = fullName;

    document.getElementById('editRole').value = user.is_admin ? 'admin' : (user.is_reviewer ? 'reviewer' : 'user');

    // Check the appropriate status
    if (user.is_suspended) {
        document.getElementById('editStatusSuspended').checked = true;
    } else {
        document.getElementById('editStatusActive').checked = true;
    }

    // Show the modal
    openModal('editUserModal');
}

async function saveUserChanges() {
    const userId = document.getElementById('editUserId').value;
    const username = document.getElementById('editUsername').value;
    const email = document.getElementById('editEmail').value;
    const fullName = document.getElementById('editFullName').value;
    const role = document.getElementById('editRole').value;
    const isActive = document.getElementById('editStatusActive').checked;

    if (!username || !email) {
        showToast('error', 'Username and email are required');
        return;
    }

    try {
        const response = await makeSecureRequest(`/api/admin/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username,
                email: email,
                full_name: fullName,
                role: role,
                is_suspended: !isActive
            })
        });

        const data = await response.json();

        if (response.ok) {
            showToast('success', data.message || 'User updated successfully');
            closeModal('editUserModal');
            // Refresh the users table
            loadUsers(currentUsersPage, getCurrentUserSearch(), getCurrentUserSort());
        } else {
            showToast('error', data.error || 'Failed to update user');
        }
    } catch (error) {
        showToast('error', 'Failed to update user');
    }
}

function suspendUser(userId, username, isLeader) {
    const user = usersData.find(u => u.id === userId);
    if (!user) return;

    const isSuspended = user.is_suspended;
    const action = isSuspended ? 'unsuspend' : 'suspend';
    const actionCap = isSuspended ? 'Unsuspend' : 'Suspend';

    // Build the HTML content
    let htmlContent = `Are you sure you want to ${action} "<strong>${username}</strong>"?`;

    // Add checkbox options if suspending a leader
    if (!isSuspended && isLeader) {
        htmlContent += `
            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-top: 1rem; text-align: left;">
                <div style="color: #92400e; font-size: 0.875rem; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Club Leader Suspension Options:</strong>
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="suspendClubMembers" style="accent-color: #ec3750;">
                        <span>Suspend all club members</span>
                    </label>
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="suspendClub" style="accent-color: #ec3750;">
                        <span>Suspend the entire club</span>
                    </label>
                </div>
            </div>
        `;
    }

    UniversalModal.custom({
        type: isSuspended ? 'info' : 'warning',
        title: `${actionCap} User`,
        html: htmlContent,
        confirmText: `${actionCap} User`,
        cancelText: 'Cancel',
        onConfirm: async function() {
            // Get checkbox values if they exist
            const suspendMembersCheckbox = document.getElementById('suspendClubMembers');
            const suspendClubCheckbox = document.getElementById('suspendClub');

            const requestBody = {
                is_suspended: !isSuspended
            };

            if (isLeader && !isSuspended) {
                requestBody.suspend_club_members = suspendMembersCheckbox ? suspendMembersCheckbox.checked : false;
                requestBody.suspend_club = suspendClubCheckbox ? suspendClubCheckbox.checked : false;
            }

            try {
                const response = await makeSecureRequest(`/api/admin/users/${userId}/suspend`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('success', data.message || `User ${action}ed successfully`);
                    loadUsers(currentUsersPage, getCurrentUserSearch(), getCurrentUserSort());
                } else {
                    showToast('error', data.error || `Failed to ${action} user`);
                }
            } catch (error) {
                console.error(`Error ${action}ing user:`, error);
                showToast('error', `Failed to ${action} user`);
            }
        }
    });
}

function remove2FA(userId, username) {
    UniversalModal.custom({
        type: 'warning',
        title: 'Remove Two-Factor Authentication',
        html: `
            <p style="margin-bottom: 1rem;">Are you sure you want to remove 2FA for <strong>${username}</strong>?</p>
            <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 1rem; text-align: left;">
                <div style="color: #92400e; font-size: 0.875rem; display: flex; align-items: start; gap: 0.5rem;">
                    <i class="fas fa-exclamation-triangle" style="margin-top: 0.125rem;"></i>
                    <div>
                        <strong>Warning:</strong> This will completely disable 2FA for this user. They will be able to log in without a second factor. Use this only for account recovery purposes.
                    </div>
                </div>
            </div>
        `,
        confirmText: 'Remove 2FA',
        cancelText: 'Cancel',
        onConfirm: async function() {
            try {
                const response = await makeSecureRequest(`/api/admin/users/${userId}/remove-2fa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('success', data.message || '2FA removed successfully');
                    loadRecentUsers();
                } else {
                    showToast('error', data.error || 'Failed to remove 2FA');
                }
            } catch (error) {
                console.error('Error removing 2FA:', error);
                showToast('error', 'Failed to remove 2FA');
            }
        }
    });
}

async function loadProjectGrantSubmissions() {
    const loading = document.getElementById('reviewLoading');
    const table = document.getElementById('reviewTable');

    try {
        const response = await fetch('/api/admin/pizza-grants');
        const data = await response.json();
        reviewData = data.submissions || [];

        renderReviewTable(reviewData);

        loading.style.display = 'none';
        table.style.display = 'table';
    } catch (error) {
        console.error('Error loading project grant submissions:', error);
        showToast('error', 'Failed to load project grant submissions');
        loading.style.display = 'none';
        document.getElementById('reviewTableBody').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #ef4444;">Failed to load submissions. Check Airtable configuration.</td></tr>';
        table.style.display = 'table';
    }
}

function renderReviewTable(submissions) {
    const tbody = document.getElementById('reviewTableBody');
    tbody.innerHTML = '';

    if (!submissions || submissions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No project grant submissions found</td></tr>';
        return;
    }

    submissions.forEach(submission => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${submission.project_name || 'N/A'}</strong></td>
            <td>${submission.first_name} ${submission.last_name}<br><small style="color: #64748b;">${submission.email}</small></td>
            <td>${submission.club_name || 'N/A'}</td>
            <td><strong style="color: #10b981;">$${submission.grant_amount || '0'}</strong></td>
            <td>${submission.hours || '0'} hrs</td>
            <td>
                <span class="status-badge ${getStatusClass(submission.status)}">
                    ${submission.status || 'Pending'}
                </span>
            </td>
            <td>${submission.created_time ? new Date(submission.created_time).toLocaleDateString() : 'N/A'}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-action btn-edit" onclick="viewSubmissionDetails('${submission.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                    ${submission.status === 'Pending' ? `
                        <button class="btn-action btn-login" onclick="approveSubmissionQuick('${submission.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn-action btn-delete" onclick="rejectSubmissionQuick('${submission.id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    ` : ''}
                    <button class="btn-action btn-suspend" onclick="deleteSubmission('${submission.id}', '${submission.project_name || 'Unknown Project'}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getStatusClass(status) {
    switch(status) {
        case 'Approved': return 'status-active';
        case 'Rejected': return 'status-suspended';
        case 'Pending': return 'status-user';
        default: return 'status-user';
    }
}

async function viewSubmissionDetails(submissionId) {
    const submission = reviewData.find(s => s.id === submissionId);
    if (!submission) return;

    currentSubmissionId = submissionId;

    const content = document.getElementById('reviewDetailsContent');
    content.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <h4 style="color: #1a202c; margin-bottom: 1rem;">Project Information</h4>
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p><strong>Project Name:</strong> ${submission.project_name || 'N/A'}</p>
                    <p><strong>Description:</strong><br>${submission.description || 'No description provided'}</p>
                    <p><strong>Hours Worked:</strong> ${submission.hours || '0'} hours</p>
                    <p><strong>Grant Amount:</strong> <span style="color: #10b981; font-weight: bold;">$${submission.grant_amount || '0'}</span></p>
                </div>

                <h4 style="color: #1a202c; margin-bottom: 1rem;">Links</h4>
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p><strong>GitHub URL:</strong> ${submission.code_url ? `<a href="${submission.code_url}" target="_blank" style="color: #ec3750;">${submission.code_url}</a>` : 'Not provided'}</p>
                    <p><strong>Live URL:</strong> ${submission.playable_url ? `<a href="${submission.playable_url}" target="_blank" style="color: #ec3750;">${submission.playable_url}</a>` : 'Not provided'}</p>
                </div>
            </div>

            <div>
                <h4 style="color: #1a202c; margin-bottom: 1rem;">Submitter Information</h4>
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p><strong>Name:</strong> ${submission.first_name} ${submission.last_name}</p>
                    <p><strong>Email:</strong> ${submission.email}</p>
                    <p><strong>GitHub Username:</strong> ${submission.github_username || 'N/A'}</p>
                    <p><strong>Club:</strong> ${submission.club_name || 'N/A'}</p>
                    <p><strong>Leader Email:</strong> ${submission.leader_email || 'N/A'}</p>
                </div>

                <h4 style="color: #1a202c; margin-bottom: 1rem;">Address</h4>
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p>${submission.address_1 || ''}</p>
                    ${submission.address_2 ? `<p>${submission.address_2}</p>` : ''}
                    <p>${submission.city || ''}, ${submission.state || ''} ${submission.zip || ''}</p>
                    <p>${submission.country || ''}</p>
                </div>
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <h4 style="color: #1a202c; margin-bottom: 1rem;">Feedback</h4>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <p><strong>What are we doing well?</strong><br>${submission.doing_well || 'No feedback provided'}</p>
                <p><strong>How can we improve?</strong><br>${submission.improve || 'No feedback provided'}</p>
            </div>
        </div>

        ${submission.screenshot_url ? `
            <div style="margin-top: 2rem;">
                <h4 style="color: #1a202c; margin-bottom: 1rem;">Screenshot</h4>
                <img src="${submission.screenshot_url}" alt="Project Screenshot" style="max-width: 100%; border-radius: 8px; border: 1px solid #e2e8f0;">
            </div>
        ` : ''}
    `;

    // Show/hide action buttons based on status
    const approveButton = document.getElementById('approveButton');
    const rejectButton = document.getElementById('rejectButton');

    if (submission.status === 'Pending') {
        approveButton.style.display = 'inline-flex';
        rejectButton.style.display = 'inline-flex';
    } else {
        approveButton.style.display = 'none';
        rejectButton.style.display = 'none';
    }

    openModal('reviewDetailsModal');
}

async function approveSubmissionQuick(submissionId) {
    if (await confirm('Are you sure you want to approve this grant?')) {
        await processSubmission(submissionId, 'approve');
    }
}

async function rejectSubmissionQuick(submissionId) {
    if (await confirm('Are you sure you want to reject this grant?')) {
        await processSubmission(submissionId, 'reject');
    }
}

async function approveSubmission() {
    if (currentSubmissionId) {
        await processSubmission(currentSubmissionId, 'approve');
        closeModal('reviewDetailsModal');
    }
}

async function rejectSubmission() {
    if (currentSubmissionId) {
        await processSubmission(currentSubmissionId, 'reject');
        closeModal('reviewDetailsModal');
    }
}

async function processSubmission(submissionId, action) {
    try {
        const response = await makeSecureRequest('/api/admin/pizza-grants/review', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_id: submissionId,
                action: action
            })
        });

        const data = await response.json();

        if (response.ok) {
            showToast('success', data.message || `Grant ${action}d successfully`);
            loadProjectGrantSubmissions(); // Refresh the table
        } else {
            showToast('error', data.error || `Failed to ${action} grant`);
        }
    } catch (error) {
        console.error(`Error ${action}ing submission:`, error);
        showToast('error', `Failed to ${action} grant`);
    }
}

// Remove this - project grant review was removed
// const reviewSearchElement = document.getElementById('reviewSearch');
// if (reviewSearchElement) {
//     reviewSearchElement.addEventListener('input', function(e) {
//         applySubmissionFilters();
//     });
// }

function applySubmissionFilters() {
    const searchTerm = document.getElementById('reviewSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;

    let filteredSubmissions = reviewData.filter(submission => {
        const matchesSearch = !searchTerm || (
            (submission.project_name && submission.project_name.toLowerCase().includes(searchTerm)) ||
            (submission.first_name && submission.first_name.toLowerCase().includes(searchTerm)) ||
            (submission.last_name && submission.last_name.toLowerCase().includes(searchTerm)) ||
            (submission.email && submission.email.toLowerCase().includes(searchTerm)) ||
            (submission.club_name && submission.club_name.toLowerCase().includes(searchTerm))
        );

        const matchesStatus = !statusFilter || submission.status === statusFilter;

        return matchesSearch && matchesStatus;
    });

    renderReviewTable(filteredSubmissions);
}

function filterSubmissionsByStatus() {
    applySubmissionFilters();
}

function deleteSubmission(submissionId, projectName) {
    UniversalModal.confirm(
        `Are you sure you want to permanently delete the submission for "<strong>${projectName}</strong>"?<br><span style="color: #ef4444; font-size: 0.9rem;">This action cannot be undone and will remove the submission from Airtable.</span>`,
        async function() {
            // User confirmed deletion
            try {
                const response = await makeSecureRequest(`/api/admin/pizza-grants/${submissionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('success', 'Submission deleted successfully');
                    loadProjectGrantSubmissions(); // Refresh the table
                } else {
                    showToast('error', data.error || 'Failed to delete submission');
                }
            } catch (error) {
                console.error('Error deleting submission:', error);
                showToast('error', 'Failed to delete submission');
            }
        },
        null,
        'Delete Submission'
    );
}

function editClub(clubId) {
    const club = clubsData.find(c => c.id === clubId);
    if (!club) return;

    // Populate edit form
    document.getElementById('editClubId').value = club.id;
    document.getElementById('editClubName').value = club.name;
    document.getElementById('editClubDescription').value = club.description || '';
    document.getElementById('editClubLocation').value = club.location || '';
    document.getElementById('editClubBalance').value = club.balance;

    openModal('editClubModal');
}

async function createNewClub() {
    const name = document.getElementById('createClubName').value;
    const description = document.getElementById('createClubDescription').value;
    const location = document.getElementById('createClubLocation').value;
    const leaderEmail = document.getElementById('createClubLeaderEmail').value;
    const balance = document.getElementById('createClubBalance').value;

    if (!name.trim()) {
        showToast('error', 'Club name is required');
        return;
    }

    if (!leaderEmail.trim()) {
        showToast('error', 'Leader email is required');
        return;
    }

    try {
        const response = await makeSecureRequest('/admin/clubs/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name.trim(),
                description: description.trim(),
                location: location.trim(),
                leader_email: leaderEmail.trim(),
                balance: parseFloat(balance) || 0
            })
        });

        const data = await response.json();

        if (response.ok) {
            showToast('success', data.message || 'Club created successfully');
            closeModal('createClubModal');
            // Clear form
            document.getElementById('createClubForm').reset();
            // Refresh the clubs list
            loadRecentClubs();
        } else {
            showToast('error', data.error || 'Failed to create club');
        }
    } catch (error) {
        console.error('Error creating club:', error);
        showToast('error', 'Error creating club');
    }
}

async function saveClubChanges() {
    const clubId = document.getElementById('editClubId').value;
    const name = document.getElementById('editClubName').value;
    const description = document.getElementById('editClubDescription').value;
    const location = document.getElementById('editClubLocation').value;
    const balance = document.getElementById('editClubBalance').value;

    if (!name.trim()) {
        showToast('error', 'Club name is required');
        return;
    }

    try {
        const response = await makeSecureRequest(`/api/admin/clubs/${clubId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name.trim(),
                description: description.trim(),
                location: location.trim(),
                balance: parseFloat(balance) || 0
            })
        });

        const data = await response.json();

        if (response.ok) {
            showToast('success', 'Club updated successfully');
            closeModal('editClubModal');
            loadRecentClubs(); // Refresh the table
        } else {
            showToast('error', data.error || 'Failed to update club');
        }
    } catch (error) {
        console.error('Error updating club:', error);
        showToast('error', 'Error updating club');
    }
}

async function loadApiKeys() {
    const loading = document.getElementById('apiKeysLoading');
    const table = document.getElementById('apiKeysTable');

    try {
        const response = await fetch('/api/admin/apikeys');
        const data = await response.json();
        apiKeysData = data.api_keys;

        renderApiKeysTable(apiKeysData);

        loading.style.display = 'none';
        table.style.display = 'table';
    } catch (error) {
        console.error('Error loading API Keys:', error);
        showToast('error', 'Failed to load API Keys');
    }
}

async function loadOAuthApps() {
    const loading = document.getElementById('oauthAppsLoading');
    const table = document.getElementById('oauthAppsTable');

    try {
        const response = await fetch('/api/admin/oauthapps');
        const data = await response.json();
        oauthAppsData = data.oauth_apps;

        renderOAuthAppsTable(oauthAppsData);

        loading.style.display = 'none';
        table.style.display = 'table';
    } catch (error) {
        console.error('Error loading OAuth Apps:', error);
        showToast('error', 'Failed to load OAuth Apps');
    }
}

function renderApiKeysTable(apiKeys) {
    const tbody = document.getElementById('apiKeysTableBody');
    tbody.innerHTML = '';

    apiKeys.forEach(apiKey => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${apiKey.name}</strong></td>
            <td>${apiKey.user}</td>
            <td>${apiKey.scopes}</td>
            <td>
                <span class="status-badge ${apiKey.is_active ? 'status-active' : 'status-suspended'}">
                    ${apiKey.is_active ? 'Active' : 'Suspended'}
                </span>
            </td>
            <td>${apiKey.last_used ? new Date(apiKey.last_used).toLocaleDateString() : 'Never'}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-action btn-edit" onclick="editApiKey(${apiKey.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn-action btn-delete" onclick="deleteApiKey(${apiKey.id}, '${apiKey.name}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderOAuthAppsTable(oauthApps) {
    const tbody = document.getElementById('oauthAppsTableBody');
    tbody.innerHTML = ``;

    oauthApps.forEach(oauthApp => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="item-info">
                    <strong>${oauthApp.name}</strong>
                    <small>${oauthApp.description || 'No description'}</small>
                </div>
            </td>
            <td><code>${oauthApp.client_id}</code></td>
            <td>${oauthApp.user}</td>
            <td>
                <div class="scopes-list">
                    ${oauthApp.scopes.map(scope => `<span class="scope-tag">${scope}</span>`).join(' ')}
                </div>
            </td>
            <td>
                <span class="status-badge ${oauthApp.require_identity_verification ? 'status-admin' : 'status-user'}">
                    ${oauthApp.require_identity_verification ? 'Required' : 'Optional'}
                </span>
            </td>
            <td>
                <span class="status-badge ${oauthApp.is_active ? 'status-active' : 'status-inactive'}">
                    ${oauthApp.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <div class="action-buttons">
                    <button class="btn-action btn-edit" onclick="editOAuthApp(${oauthApp.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn-action btn-delete" onclick="deleteOAuthApp(${oauthApp.id}, '${oauthApp.name}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

async function createApiKey() {
    const apiKeyName = document.getElementById('apiKeyName').value.trim();
    const apiKeyDescription = document.getElementById('apiKeyDescription').value.trim();
    const apiKeyUserEmail = document.getElementById('apiKeyUserEmail').value.trim();
    const apiKeyRateLimit = parseInt(document.getElementById('apiKeyRateLimit').value) || 1000;
    const apiKeyScopes = Array.from(document.getElementById('apiKeyScopes').selectedOptions).map(option => option.value);

    if (!apiKeyName) {
        showToast('error', 'API Key name is required');
        return;
    }

    if (apiKeyScopes.length === 0) {
        showToast('error', 'At least one scope is required');
        return;
    }

    try {
        const requestBody = {
            name: apiKeyName,
            scopes: apiKeyScopes,
            rate_limit: apiKeyRateLimit
        };

        if (apiKeyDescription) {
            requestBody.description = apiKeyDescription;
        }

        if (apiKeyUserEmail) {
            requestBody.user_email = apiKeyUserEmail;
        }

        const response = await makeSecureRequest('/api/admin/apikeys', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        const data = await response.json();

        if (response.ok) {
            closeModal('addApiKeyModal');
            document.getElementById('addApiKeyForm').reset();
            loadApiKeys();

            // Show the generated API key in a modal
            document.getElementById('generatedApiKey').value = data.api_key;
            openModal('apiKeyModal');
        } else {
            showToast('error', data.error || 'Failed to create API Key');
        }
    } catch (error) {
        console.error('Error creating API key:', error);
        showToast('error', 'Failed to create API Key');
    }
}

async function createOAuthApp() {
    const oauthAppName = document.getElementById('oauthAppName').value.trim();
    const oauthAppRedirectUris = document.getElementById('oauthAppRedirectUris').value.trim();
    const oauthAppScopes = Array.from(document.getElementById('oauthAppScopes').selectedOptions).map(option => option.value);
    const requireIdentityVerification = document.getElementById('oauthAppRequireIdentityVerification').checked;

    if (!oauthAppName) {
        showToast('error', 'Application name is required');
        return;
    }

    if (!oauthAppRedirectUris) {
        showToast('error', 'Redirect URIs are required');
        return;
    }

    if (oauthAppScopes.length === 0) {
        showToast('error', 'At least one scope is required');
        return;
    }

    try {
        const response = await makeSecureRequest('/api/admin/oauthapps', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: oauthAppName,
                redirect_uris: oauthAppRedirectUris.split(',').map(uri => uri.trim()),
                scopes: oauthAppScopes,
                require_identity_verification: requireIdentityVerification
            })
        });

        const data = await response.json();

        if (response.ok) {
            closeModal('addOAuthAppModal');
            document.getElementById('addOAuthAppForm').reset();
            loadOAuthApps();

            document.getElementById('generatedClientId').value = data.client_id;
            document.getElementById('generatedClientSecret').value = data.client_secret;
            openModal('oauthCredentialsModal');
        } else {
            const error = await response.json();
            showToast('error', error.error || 'Failed to create OAuth Application');
        }
    } catch (error) {
        showToast('error', 'Failed to create OAuth Application');
    }
}

function editApiKey(apiKeyId) {
    const apiKey = apiKeysData.find(k => k.id === apiKeyId);
    if (!apiKey) return;

    document.getElementById('editApiKeyId').value = apiKey.id;
    document.getElementById('editApiKeyName').value = apiKey.name;
    document.getElementById('editApiKeyDescription').value = apiKey.description || '';
    document.getElementById('editApiKeyRateLimit').value = apiKey.rate_limit;
    document.getElementById('editApiKeyActive').checked = apiKey.is_active;

    openModal('editApiKeyModal');
}

function saveApiKeyChanges() {
    const apiKeyId = document.getElementById('editApiKeyId').value;
    const name = document.getElementById('editApiKeyName').value.trim();
    const description = document.getElementById('editApiKeyDescription').value.trim();
    const rateLimit = parseInt(document.getElementById('editApiKeyRateLimit').value);
    const isActive = document.getElementById('editApiKeyActive').checked;

    if (!name) {
        showToast('error', 'API Key name is required');
        return;
    }

    if (!rateLimit || rateLimit < 1 || rateLimit > 10000) {
        showToast('error', 'Rate limit must be between 1 and 10000');
        return;
    }

    updateApiKey(apiKeyId, {
        name: name,
        description: description,
        rate_limit: rateLimit,
        is_active: isActive
    });

    closeModal('editApiKeyModal');
}

async function updateApiKey(apiKeyId, updateData) {
    try {
        const response = await makeSecureRequest(`/api/admin/api-keys/${apiKeyId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });

        if (response.ok) {
            showToast('success', 'API key updated successfully');
            loadApiKeys();
        } else {
            const error = await response.json();
            showToast('error', error.error || 'Failed to update API key');
        }
    } catch (error) {
        showToast('error', 'Failed to update API key');
    }
}

function deleteApiKey(apiKeyId, apiKeyName) {
    UniversalModal.confirm(
        `Are you sure you want to delete API key "<strong>${apiKeyName}</strong>"?<br><span style="color: #ef4444; font-size: 0.9rem;">This action cannot be undone.</span>`,
        async function() {
            // User confirmed deletion
            try {
                const response = await makeSecureRequest(`/api/admin/api-keys/${apiKeyId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('success', 'API key deleted successfully');
                    loadApiKeys();
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to delete API key');
                }
            } catch (error) {
                showToast('error', 'Failed to delete API key');
            }
        },
        null,
        'Delete API Key'
    );
}

function editOAuthApp(oauthAppId) {
    const oauthApp = oauthAppsData.find(app => app.id === oauthAppId);
    if (!oauthApp) return;

    document.getElementById('editOAuthAppId').value = oauthApp.id;
    document.getElementById('editOAuthAppName').value = oauthApp.name;
    document.getElementById('editOAuthAppDescription').value = oauthApp.description || '';
   document.getElementById('editOAuthAppRedirectUris').value = oauthApp.redirect_uris.join(', ');
    document.getElementById('editOAuthAppActive').checked = oauthApp.is_active;

    // Set selected scopes
    const scopesSelect = document.getElementById('editOAuthAppScopes');
    Array.from(scopesSelect.options).forEach(option => {
        option.selected = oauthApp.scopes.includes(option.value);
    });

    openModal('editOAuthAppModal');
}

function saveOAuthAppChanges() {
    const oauthAppId = document.getElementById('editOAuthAppId').value;
    const name = document.getElementById('editOAuthAppName').value.trim();
    const description = document.getElementById('editOAuthAppDescription').value.trim();
    const redirectUris = document.getElementById('editOAuthAppRedirectUris').value.trim();
    const isActive = document.getElementById('editOAuthAppActive').checked;

    if (!name) {
        showToast('error', 'Application name is required');
        return;
    }

    if (!redirectUris) {
        showToast('error', 'Redirect URIs are required');
        return;
    }

    updateOAuthApp(oauthAppId, {
        name: name,
        description: description,
        redirect_uris: redirectUris.split(',').map(uri => uri.trim()),
        is_active: isActive
    });

    closeModal('editOAuthAppModal');
}

async function updateOAuthApp(oauthAppId, updateData) {
    try {
        const response = await makeSecureRequest(`/api/admin/oauth-applications/${oauthAppId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });

        if (response.ok) {
            showToast('success', 'OAuth application updated successfully');
            loadOAuthApps();
        } else {
            const error = await response.json();
            showToast('error', error.error || 'Failed to update OAuth application');
        }
    } catch (error) {
        showToast('error', 'Failed to update OAuth application');
    }
}


function deleteOAuthApp(oauthAppId, oauthAppName) {
    UniversalModal.confirm(
        `Are you sure you want to delete OAuth application "<strong>${oauthAppName}</strong>"?<br><span style="color: #ef4444; font-size: 0.9rem;">This will also delete all related tokens and authorization codes. This action cannot be undone.</span>`,
        async function() {
            // User confirmed deletion
            try {
                const response = await makeSecureRequest(`/api/admin/oauth-applications/${oauthAppId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('success', 'OAuth application deleted successfully');
                    loadOAuthApps();
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to delete OAuth application');
                }
            } catch (error) {
                showToast('error', 'Failed to delete OAuth application');
            }
        },
        null,
        'Delete OAuth Application'
    );
}


function executeConfirmedAction() {
    console.log('[DEBUG] executeConfirmedAction called - user clicked CONFIRM button');
    console.log('[DEBUG] pendingAction:', pendingAction);

    // Close the modal first
    closeModal('confirmModal');

    // Then execute the action
    if (pendingAction === 'transferLeadership') {
        executeTransferLeadership();
    }
    // Note: All delete operations now use UniversalModal directly with callbacks

    // Clear pending action
    pendingAction = null;
    pendingUserId = null;
    pendingUsername = null;
}

 document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal-backdrop')) {
   e.target.classList.remove('show');
  }
 });

function copyApiKey() {
    const apiKeyInput = document.getElementById('generatedApiKey');
    apiKeyInput.select();
    apiKeyInput.setSelectionRange(0, 99999); // For mobile devices

    navigator.clipboard.writeText(apiKeyInput.value).then(() => {
        // Only show one toast message
        showToast('success', 'API key copied to clipboard!');

        // Update the copy button to show success
        const copyButton = event.target.closest('button');
        const originalHtml = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
        copyButton.style.background = '#10b981';

        setTimeout(() => {
            copyButton.innerHTML = originalHtml;
            copyButton.style.background = '#ec3750';
        }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        try {
            document.execCommand('copy');
            // Only show one toast message on fallback too
            showToast('success', 'API key copied to clipboard!');
        } catch (err) {
            showToast('error', 'Failed to copy API key. Please select and copy manually.');
        }
    });
}

function copyClientId() {
    const clientIdInput = document.getElementById('generatedClientId');
    clientIdInput.select();
    clientIdInput.setSelectionRange(0, 99999);

    navigator.clipboard.writeText(clientIdInput.value).then(() => {
        showToast('success', 'Client ID copied to clipboard!');

        const copyButton = event.target.closest('button');
        const originalHtml = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
        copyButton.style.background = '#10b981';

        setTimeout(() => {
            copyButton.innerHTML = originalHtml;
            copyButton.style.background = '#ec3750';
        }, 2000);
    }).catch(() => {
        try {
            document.execCommand('copy');
            showToast('success', 'Client ID copied to clipboard!');
        } catch (err) {
            showToast('error', 'Failed to copy Client ID. Please select and copy manually.');
        }
    });
}

function copyClientSecret() {
    const clientSecretInput = document.getElementById('generatedClientSecret');
    clientSecretInput.select();
    clientSecretInput.setSelectionRange(0, 99999);

    navigator.clipboard.writeText(clientSecretInput.value).then(() => {
        showToast('success', 'Client Secret copied to clipboard!');

        const copyButton = event.target.closest('button');
        const originalHtml = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
        copyButton.style.background = '#10b981';

        setTimeout(() => {
            copyButton.innerHTML = originalHtml;
            copyButton.style.background = '#ec3750';
        }, 2000);
    }).catch(() => {
        try {
            document.execCommand('copy');
            showToast('success', 'Client Secret copied to clipboard!');
        } catch (err) {
            showToast('error', 'Failed to copy Client Secret. Please select and copy manually.');
        }
    });
}

// Toast notification function
function showToast(type, message) {
    // Create toast element
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        max-width: 400px;
        word-wrap: break-word;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        transform: translateX(100%);
    `;

    // Set background color based on type
    switch(type) {
        case 'success':
            toast.style.backgroundColor = '#10b981';
            break;
        case 'error':
            toast.style.backgroundColor = '#ef4444';
            break;
        case 'info':
            toast.style.backgroundColor = '#3b82f6';
            break;
        default:
            toast.style.backgroundColor = '#6b7280';
    }

    toast.textContent = message;
    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);

    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 5000);

    // Allow manual close on click
    toast.addEventListener('click', () => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    });
}

// globalDropdownMenu is now declared at the top of script section

// Dropdown functionality
function toggleDropdown(button) {
    const dropdown = button.closest('.action-dropdown');
    const menu = dropdown.querySelector('.dropdown-menu');
    const isActive = menu && menu.classList.contains('show');

    // Close any existing dropdown
    closeAllDropdowns();

    if (!isActive) {
        // Create or show dropdown
        showDropdownMenu(button, menu);
    }
}

function showDropdownMenu(button, menu) {
    // Get button position relative to viewport
    const rect = button.getBoundingClientRect();

    // Create a new dropdown menu outside the table
    if (!globalDropdownMenu) {
        globalDropdownMenu = document.createElement('div');
        globalDropdownMenu.className = 'dropdown-menu';
        document.body.appendChild(globalDropdownMenu);
    }

    // Copy menu content
    globalDropdownMenu.innerHTML = menu.innerHTML;

    // Position the dropdown
    const menuWidth = 160; // min-width from CSS
    const menuHeight = globalDropdownMenu.scrollHeight || 200;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    let left = rect.right - menuWidth; // Align to right edge of button
    let top = rect.bottom + 5; // Below the button

    // Adjust if dropdown would go off-screen
    if (left < 10) {
        left = rect.left; // Align to left edge instead
    }
    if (left + menuWidth > viewportWidth - 10) {
        left = viewportWidth - menuWidth - 10;
    }
    if (top + menuHeight > viewportHeight - 10) {
        top = rect.top - menuHeight - 5; // Above the button instead
    }
    if (top < 10) {
        top = 10;
    }

    globalDropdownMenu.style.left = left + 'px';
    globalDropdownMenu.style.top = top + 'px';
    globalDropdownMenu.classList.add('show');
}

function closeDropdown(element) {
    closeAllDropdowns();
}

function closeAllDropdowns() {
    // Check if globalDropdownMenu exists and is initialized
    if (globalDropdownMenu && globalDropdownMenu.classList) {
        globalDropdownMenu.classList.remove('show');
    }
    // Also remove any old active states
    document.querySelectorAll('.action-dropdown.active').forEach(dropdown => {
        dropdown.classList.remove('active');
    });
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    // Don't close if any modal is currently visible
    const openModals = document.querySelectorAll('.modal-backdrop.show');
    if (openModals.length > 0) {
        return; // A modal is open, don't close dropdowns
    }

    if (!event.target.closest('.action-dropdown') && !event.target.closest('.dropdown-menu')) {
        closeAllDropdowns();
    }
});

// Close dropdowns on scroll to prevent misalignment
document.addEventListener('scroll', function() {
    closeAllDropdowns();
}, true);

// Close dropdowns on window resize
window.addEventListener('resize', function() {
    closeAllDropdowns();
});

async function deleteUser(userId, username) {
    console.log('[DEBUG] deleteUser called:', userId, username);

    UniversalModal.confirm(
        `Are you sure you want to delete the user "<strong>${username}</strong>"?<br><span style="color: #ef4444; font-size: 0.9rem;">This action cannot be undone.</span>`,
        async function() {
            // User confirmed deletion
            console.log('[DEBUG] User confirmed deletion of:', username);
            try {
                const response = await makeSecureRequest(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('success', 'User deleted successfully');
                    loadUsers();
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('error', 'Failed to delete user');
            }
        },
        null,
        'Delete User'
    );
}

async function deleteClub(clubId, clubName) {
    console.log('[DEBUG] deleteClub called:', clubId, clubName);

    UniversalModal.confirm(
        `Are you sure you want to delete the club "<strong>${clubName}</strong>"?<br><span style="color: #ef4444; font-size: 0.9rem;">This action cannot be undone.</span>`,
        async function() {
            // User confirmed deletion
            console.log('[DEBUG] User confirmed deletion of:', clubName);
            try {
                const response = await makeSecureRequest(`/api/admin/clubs/${clubId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('success', 'Club deleted successfully');
                    loadRecentClubs();
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to delete club');
                }
            } catch (error) {
                console.error('Error deleting club:', error);
                showToast('error', 'Failed to delete club');
            }
        },
        null,
        'Delete Club'
    );
}

async function executeDeleteUser() {
    console.log('[DEBUG] executeDeleteUser called - THIS SHOULD ONLY HAPPEN AFTER CLICKING CONFIRM!');
    console.log('[DEBUG] pendingUserId:', pendingUserId);
    try {
        const response = await makeSecureRequest(`/api/admin/users/${pendingUserId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('success', 'User deleted successfully');
            loadUsers(currentUsersPage, getCurrentUserSearch(), getCurrentUserSort());
        } else {
            const error = await response.json();
            showToast('error', error.error || 'Failed to delete user');
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        showToast('error', 'Failed to delete user');
    }
}

async function executeDeleteClub() {
    console.log('[DEBUG] executeDeleteClub called - THIS SHOULD ONLY HAPPEN AFTER CLICKING CONFIRM!');
    console.log('[DEBUG] pendingUserId (clubId):', pendingUserId);
    try {
        const response = await makeSecureRequest(`/api/admin/clubs/${pendingUserId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('success', 'Club deleted successfully');
            loadRecentClubs();
        } else {
            const error = await response.json();
            showToast('error', error.error || 'Failed to delete club');
        }
    } catch (error) {
        console.error('Error deleting club:', error);
        showToast('error', 'Failed to delete club');
    }
}

// Note: executeDeleteUser and executeDeleteClub removed - now using UniversalModal callbacks directly

function toggleSyncImmune(clubId, clubName, currentStatus) {
    const action = currentStatus ? 'disable' : 'enable';
    const actionCapitalized = action.charAt(0).toUpperCase() + action.slice(1);

    UniversalModal.confirm(
        `Are you sure you want to <strong>${action}</strong> Sync Immune for "<strong>${clubName}</strong>"?<br><br>` +
        `<span style="color: ${currentStatus ? '#dc2626' : '#16a34a'};">` +
        `${currentStatus
            ? '<i class="fas fa-exclamation-triangle"></i> The club will be required to connect to the directory to access the dashboard.'
            : '<i class="fas fa-shield-alt"></i> The club will bypass the intrusive connection popup (banner will still show).'}` +
        `</span>`,
        async function() {
            // User confirmed
            const newStatus = !currentStatus;
            try {
                const response = await makeSecureRequest(`/api/admin/clubs/${clubId}/sync-immune`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sync_immune: newStatus
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('success', result.message || `Sync immune ${action}d successfully`);
                    loadRecentClubs(); // Refresh the clubs list
                } else {
                    const error = await response.json();
                    showToast('error', error.error || `Failed to ${action} sync immune`);
                }
            } catch (error) {
                console.error(`Error toggling sync immune:`, error);
                showToast('error', `Failed to ${action} sync immune`);
            }
        },
        null,
        `${actionCapitalized} Sync Immune`
    );
}

async function editClub(clubId) {
    const club = clubsData.find(c => c.id === clubId);
    if (!club) {
        showToast('error', 'Club not found');
        return;
    }

    document.getElementById('editClubId').value = club.id;
    document.getElementById('editClubName').value = club.name;
    document.getElementById('editClubDescription').value = club.description || '';
    document.getElementById('editClubLocation').value = club.location || '';
    document.getElementById('editClubBalance').value = club.balance;

    openModal('editClubModal');
}

function viewClub(clubId) {
    // Redirect to club dashboard with admin access
    window.location.href = `/club-dashboard/${clubId}?admin=true`;
}

// User Info Functions
async function viewUserInfo(userId) {
    try {
        openModal('userInfoModal');
        showUserInfoLoading(true);
        showUserInfoDetails(false);

        const response = await fetch(`/api/admin/users/${userId}/ips`);
        const data = await response.json();

        if (response.ok) {
            populateUserInfo(data);
            showUserInfoDetails(true);
        } else {
            throw new Error(data.error || 'Failed to get user information');
        }
    } catch (error) {
        console.error('Error getting user info:', error);
        showToast('error', 'Failed to get user information. Please try again.');
        closeModal('userInfoModal');
    } finally {
        showUserInfoLoading(false);
    }
}

function showUserInfoLoading(show) {
    document.getElementById('userInfoLoading').style.display = show ? 'block' : 'none';
}

function showUserInfoDetails(show) {
    document.getElementById('userInfoDetails').style.display = show ? 'block' : 'none';
}

function populateUserInfo(data) {
    // Basic information
    document.getElementById('modalUsername').textContent = data.username || 'N/A';
    document.getElementById('modalEmail').textContent = data.email || 'N/A';
    document.getElementById('modalFullName').textContent =
        (data.first_name || data.last_name) ? `${data.first_name || ''} ${data.last_name || ''}`.trim() : 'N/A';
    document.getElementById('modalRole').innerHTML =
        `<span class="badge ${data.is_admin ? 'badge-warning' : (data.is_reviewer ? 'badge-info' : 'badge-primary')}">${data.is_admin ? 'Admin' : (data.is_reviewer ? 'Reviewer' : 'User')}</span>`;
    document.getElementById('modalStatus').innerHTML =
        `<span class="badge ${data.is_suspended ? 'badge-danger' : 'badge-success'}">${data.is_suspended ? 'Suspended' : 'Active'}</span>`;
    document.getElementById('modalCreated').textContent =
        data.created_at ? new Date(data.created_at).toLocaleString() : 'N/A';
    document.getElementById('modalLastLogin').textContent =
        data.last_login ? new Date(data.last_login).toLocaleString() : 'Never';

    // Security information
    document.getElementById('modalRegistrationIP').textContent = data.registration_ip || 'N/A';
    document.getElementById('modalLastLoginIP').textContent = data.last_login_ip || 'N/A';
    document.getElementById('modalTotalIPs').textContent = data.total_ips || 0;

    // IP History
    const ipHistoryContainer = document.getElementById('modalIPHistory');
    if (data.all_ips && data.all_ips.length > 0) {
        const ipCounts = {};
        data.all_ips.forEach(ip => {
            ipCounts[ip] = (ipCounts[ip] || 0) + 1;
        });

        const ipEntries = Object.entries(ipCounts)
            .sort((a, b) => b[1] - a[1]) // Sort by frequency
            .map(([ip, count]) => {
                let type = 'Historical';
                let badgeClass = 'badge-secondary';

                if (ip === data.registration_ip) {
                    type = 'Registration';
                    badgeClass = 'badge-success';
                } else if (ip === data.last_login_ip) {
                    type = 'Last Login';
                    badgeClass = 'badge-warning';
                }

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;">
                        <div>
                            <code style="margin-right: 0.5rem;">${escapeHtml(ip)}</code>
                            <span class="badge ${badgeClass}">${type}</span>
                        </div>
                        <span style="color: #64748b; font-size: 0.9rem;">${count} time${count > 1 ? 's' : ''}</span>
                    </div>
                `;
            });

        ipHistoryContainer.innerHTML = ipEntries.join('');
    } else {
        ipHistoryContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 1rem;">No IP history available</p>';
    }
}

function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return String(unsafe)
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

// Audit Logs Functionality
let logsData = [];
let logsCurrentPage = 1;

async function loadLogs(page = 1) {
    try {
        const logsLoading = document.getElementById('logsLoading');
        const logsTable = document.getElementById('logsTable');

        logsLoading.style.display = 'block';
        logsTable.style.display = 'none';

        // Get filter values
        const search = document.getElementById('logsSearch').value.trim();
        const category = document.getElementById('categoryFilter').value;
        const severity = document.getElementById('severityFilter').value;
        const sortOrder = document.getElementById('sortOrder').value;

        // Build query parameters
        const params = new URLSearchParams({
            page: page,
            per_page: 50,
            sort: sortOrder
        });

        if (search) params.append('search', search);
        if (category) params.append('category', category);
        if (severity) params.append('severity', severity);

        const response = await fetch(`/api/admin/audit-logs?${params}`);
        const data = await response.json();

        if (response.ok) {
            logsData = data.logs;
            logsCurrentPage = page;
            renderLogsTable(data.logs);

            // Build pagination object from API response
            const pagination = {
                page: data.page,
                pages: data.pages,
                total: data.total,
                per_page: data.per_page,
                has_prev: data.page > 1,
                has_next: data.page < data.pages
            };
            renderLogsPagination(pagination);

            logsLoading.style.display = 'none';
            logsTable.style.display = 'table';
        } else {
            console.error('Failed to load logs:', data.error);
            logsLoading.innerHTML = '<p style="color: #ef4444;">Failed to load audit logs</p>';
        }
    } catch (error) {
        console.error('Error loading logs:', error);
        document.getElementById('logsLoading').innerHTML = '<p style="color: #ef4444;">Error loading audit logs</p>';
    }
}

function renderLogsTable(logs) {
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '';

    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">No audit logs found</td></tr>';
        return;
    }

    logs.forEach(log => {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.onclick = () => showLogDetails(log);

        // Format timestamp
        const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : 'Unknown';

        // Format severity badge
        const severityClass = {
            'info': 'status-info',
            'warning': 'status-warning',
            'error': 'status-suspended',
            'critical': 'status-suspended'
        }[log.severity] || 'status-user';

        // Format category badge
        const categoryClass = {
            'auth': 'status-active',
            'user': 'status-user',
            'club': 'status-admin',
            'project': 'status-reviewer',
            'admin': 'status-warning',
            'security': 'status-suspended',
            'gallery': 'status-active',
            'other': 'status-user'
        }[log.action_category] || 'status-user';

        row.innerHTML = `
            <td style="font-size: 0.8rem;">${escapeHtml(timestamp)}</td>
            <td><strong>${escapeHtml(log.username || 'System')}</strong></td>
            <td><code style="font-size: 0.8rem;">${escapeHtml(log.action_type)}</code></td>
            <td><span class="status-badge ${categoryClass}">${escapeHtml(log.action_category)}</span></td>
            <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(log.description)}</td>
            <td><span class="status-badge ${severityClass}">${escapeHtml(log.severity)}</span></td>
            <td style="font-size: 0.8rem;"><code>${escapeHtml(log.ip_address || 'Unknown')}</code></td>
        `;

        tbody.appendChild(row);
    });
}

function renderLogsPagination(pagination) {
    const container = document.getElementById('logsPagination');

    if (pagination.pages <= 1) {
        container.innerHTML = '';
        return;
    }

    let paginationHtml = `
        <div class="pagination-info">
            Showing ${(pagination.page - 1) * pagination.per_page + 1}-${Math.min(pagination.page * pagination.per_page, pagination.total)} of ${pagination.total} logs
        </div>
        <div class="pagination">
            <div class="pagination-buttons">
    `;

    // Previous button
    if (pagination.has_prev) {
        paginationHtml += `<button class="pagination-btn" onclick="loadLogs(${pagination.page - 1})"><i class="fas fa-chevron-left"></i> Previous</button>`;
    } else {
        paginationHtml += `<button class="pagination-btn" disabled><i class="fas fa-chevron-left"></i> Previous</button>`;
    }

    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);

    if (startPage > 1) {
        paginationHtml += `<button class="pagination-btn" onclick="loadLogs(1)">1</button>`;
        if (startPage > 2) {
            paginationHtml += `<span style="padding: 0.5rem;">...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === pagination.page ? 'active' : '';
        paginationHtml += `<button class="pagination-btn ${isActive}" onclick="loadLogs(${i})">${i}</button>`;
    }

    if (endPage < pagination.pages) {
        if (endPage < pagination.pages - 1) {
            paginationHtml += `<span style="padding: 0.5rem;">...</span>`;
        }
        paginationHtml += `<button class="pagination-btn" onclick="loadLogs(${pagination.pages})">${pagination.pages}</button>`;
    }

    // Next button
    if (pagination.has_next) {
        paginationHtml += `<button class="pagination-btn" onclick="loadLogs(${pagination.page + 1})">Next <i class="fas fa-chevron-right"></i></button>`;
    } else {
        paginationHtml += `<button class="pagination-btn" disabled>Next <i class="fas fa-chevron-right"></i></button>`;
    }

    paginationHtml += `
            </div>
            <div class="page-size-selector">
                <label>Items per page:</label>
                <select onchange="changeLogsPerPage(this.value)">
                    <option value="25" ${pagination.per_page === 25 ? 'selected' : ''}>25</option>
                    <option value="50" ${pagination.per_page === 50 ? 'selected' : ''}>50</option>
                    <option value="100" ${pagination.per_page === 100 ? 'selected' : ''}>100</option>
                </select>
            </div>
        </div>
    `;

    container.innerHTML = paginationHtml;
}

function showLogDetails(log) {
    // Format the details nicely
    const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'Unknown';

    let detailsHtml = `
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div><strong>Timestamp:</strong></div>
            <div>${escapeHtml(timestamp)}</div>

            <div><strong>User:</strong></div>
            <div>${escapeHtml(log.username || 'System')}</div>

            <div><strong>Action Type:</strong></div>
            <div><code style="font-size: 0.9rem;">${escapeHtml(log.action_type)}</code></div>

            <div><strong>Category:</strong></div>
            <div><span class="status-badge">${escapeHtml(log.action_category)}</span></div>

            <div><strong>Severity:</strong></div>
            <div><span class="status-badge">${escapeHtml(log.severity)}</span></div>

            <div><strong>Description:</strong></div>
            <div>${escapeHtml(log.description)}</div>

            <div><strong>IP Address:</strong></div>
            <div><code style="font-size: 0.9rem;">${escapeHtml(log.ip_address || 'Unknown')}</code></div>

            ${log.target_type ? `
                <div><strong>Target:</strong></div>
                <div>${escapeHtml(log.target_type)}${log.target_id ? ` (ID: ${log.target_id})` : ''}</div>
            ` : ''}
        </div>
    `;

    // Add detailed information if available
    if (log.details && Object.keys(log.details).length > 0) {
        detailsHtml += `
            <div style="margin-top: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: #1a202c; font-size: 1rem;">Additional Details:</h4>
                <pre style="background: #f8fafc; padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.85rem; border: 1px solid #e2e8f0;">${escapeHtml(JSON.stringify(log.details, null, 2))}</pre>
            </div>
        `;
    }

    // Add user agent if available
    if (log.user_agent) {
        detailsHtml += `
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                <strong style="display: block; margin-bottom: 0.5rem;">User Agent:</strong>
                <div style="font-size: 0.85rem; color: #64748b; word-break: break-all; font-family: monospace;">${escapeHtml(log.user_agent)}</div>
            </div>
        `;
    }

    // Use UniversalModal for consistent styling
    UniversalModal.show(
        detailsHtml,
        null,
        null,
        'Audit Log Details'
    );
}

function refreshLogs() {
    loadLogs(1);
}

function changeLogsPerPage(perPage) {
    // This would need to be implemented to change per_page and reload
    loadLogs(1);
}

// Event listeners for filters
document.addEventListener('DOMContentLoaded', function() {
    // Load logs when filters change
    document.getElementById('logsSearch').addEventListener('input', debounce(() => loadLogs(1), 500));
    document.getElementById('categoryFilter').addEventListener('change', () => loadLogs(1));
    document.getElementById('severityFilter').addEventListener('change', () => loadLogs(1));
    document.getElementById('sortOrder').addEventListener('change', () => loadLogs(1));
});

// Settings Management Functions
function loadSettings() {
    // Load current settings from backend
    makeSecureRequest('/api/admin/settings')
        .then(response => response.json())
        .then(data => {
            // Update toggle switches - API returns boolean values directly
            document.getElementById('maintenanceMode').checked = data.maintenance_mode === true;
            document.getElementById('economyEnabled').checked = data.economy_enabled === true;
            document.getElementById('clubCreationEnabled').checked = data.club_creation_enabled === true;
            document.getElementById('userRegistrationEnabled').checked = data.registration_enabled === true;

            // Load banner settings - TODO: Add banner_enabled to API
            // const bannerEnabled = data.banner_enabled === true;
            // document.getElementById('bannerEnabled').checked = bannerEnabled;

            // Handle admin economy override - TODO: Add to API if needed
            const economyEnabled = data.economy_enabled === true;
            const adminOverrideDiv = document.getElementById('adminEconomyOverride');
            const adminOverrideCheckbox = document.getElementById('adminEconomyEnabled');

            if (adminOverrideDiv && adminOverrideCheckbox) {
                if (!economyEnabled) {
                    // Show admin override option when economy is disabled
                    adminOverrideDiv.style.display = 'block';
                    adminOverrideCheckbox.checked = false; // Default to false for now
                } else {
                    // Hide admin override option when economy is enabled
                    adminOverrideDiv.style.display = 'none';
                    adminOverrideCheckbox.checked = false;
                }
            }

            // Update status display
            document.getElementById('maintenanceStatus').textContent =
                data.maintenance_mode === true ? 'Enabled' : 'Disabled';
            document.getElementById('economyStatus').textContent =
                data.economy_enabled === true ? 'Enabled' : 'Disabled';
            document.getElementById('clubCreationStatus').textContent =
                data.club_creation_enabled === true ? 'Enabled' : 'Disabled';
            document.getElementById('userRegistrationStatus').textContent =
                data.registration_enabled === true ? 'Enabled' : 'Disabled';

            // Update status colors
            document.getElementById('maintenanceStatus').style.color =
                data.maintenance_mode === true ? '#dc2626' : '#10b981';
            document.getElementById('economyStatus').style.color =
                data.economy_enabled === true ? '#10b981' : '#dc2626';
            document.getElementById('clubCreationStatus').style.color =
                data.club_creation_enabled === true ? '#10b981' : '#dc2626';
            document.getElementById('userRegistrationStatus').style.color =
                data.registration_enabled === true ? '#10b981' : '#dc2626';
        })
        .catch(error => {
            console.error('Error loading settings:', error);
            showToast('error', 'Failed to load settings');
        });
}

async function toggleMaintenanceMode() {
    const checkbox = document.getElementById('maintenanceMode');
    const enabled = checkbox.checked;

    // Show confirmation dialog for maintenance mode
    if (enabled) {
        const confirmed = await confirm('Are you sure you want to enable maintenance mode? This will show a maintenance page to all users except admins.');
        if (!confirmed) {
            // User cancelled - revert checkbox WITHOUT triggering onchange
            checkbox.onchange = null;
            checkbox.checked = false;
            setTimeout(() => checkbox.onchange = toggleMaintenanceMode, 0);
            return;
        }
    }

    updateSetting('maintenance_mode', enabled.toString());
}

async function toggleEconomySystem() {
    const checkbox = document.getElementById('economyEnabled');
    const enabled = checkbox.checked;
    const adminOverrideDiv = document.getElementById('adminEconomyOverride');

    // Show confirmation dialog for economy disable
    if (!enabled) {
        const confirmed = await confirm('Are you sure you want to disable the economy system? This will hide the shop, tokens, and project submissions from all users.');
        if (!confirmed) {
            // User cancelled - revert checkbox WITHOUT triggering onchange
            checkbox.onchange = null;
            checkbox.checked = true;
            setTimeout(() => checkbox.onchange = toggleEconomySystem, 0);
            return;
        }
        // Show admin override option when economy is disabled
        adminOverrideDiv.style.display = 'block';
    } else {
        // Hide admin override option when economy is enabled
        adminOverrideDiv.style.display = 'none';
        // Also disable admin override if economy is being enabled
        document.getElementById('adminEconomyEnabled').checked = false;
        updateSetting('admin_economy_override', 'false');
    }

    updateSetting('economy_enabled', enabled.toString());
}

function toggleAdminEconomyOverride() {
    const checkbox = document.getElementById('adminEconomyEnabled');
    const enabled = checkbox.checked;

    updateSetting('admin_economy_override', enabled.toString());
}

async function toggleClubCreation() {
    const checkbox = document.getElementById('clubCreationEnabled');
    const enabled = checkbox.checked;

    // Show confirmation dialog for club creation disable
    if (!enabled) {
        const confirmed = await confirm('Are you sure you want to disable club creation? Users will not be able to create new clubs.');
        if (!confirmed) {
            // User cancelled - revert checkbox WITHOUT triggering onchange
            checkbox.onchange = null;
            checkbox.checked = true;
            setTimeout(() => checkbox.onchange = toggleClubCreation, 0);
            return;
        }
    }

    updateSetting('club_creation_enabled', enabled.toString());
}

async function toggleUserRegistration() {
    const checkbox = document.getElementById('userRegistrationEnabled');
    const enabled = checkbox.checked;

    // Show confirmation dialog for user registration disable
    if (!enabled) {
        const confirmed = await confirm('Are you sure you want to disable user registration? New users will not be able to create accounts.');
        if (!confirmed) {
            // User cancelled - revert checkbox WITHOUT triggering onchange
            checkbox.onchange = null;
            checkbox.checked = true;
            setTimeout(() => checkbox.onchange = toggleUserRegistration, 0);
            return;
        }
    }

    updateSetting('user_registration_enabled', enabled.toString());
}

function updateSetting(key, value) {
    console.log('[DEBUG] updateSetting called with key:', key, 'value:', value);
    
    // Convert string booleans to actual booleans
    let settingValue = value;
    if (value === 'true' || value === true) {
        settingValue = true;
    } else if (value === 'false' || value === false) {
        settingValue = false;
    }
    
    // Build the payload with the key as the property name
    const payload = {};
    payload[key] = settingValue;
    
    console.log('[DEBUG] Sending payload:', JSON.stringify(payload));
    
    makeSecureRequest('/api/admin/settings', {
        method: 'POST',
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Setting updated successfully');
            loadSettings(); // Reload to ensure consistency
        } else {
            showToast('error', 'Failed to update setting: ' + (data.message || 'Unknown error'));
            loadSettings(); // Reload to reset UI state
        }
    })
    .catch(error => {
        console.error('Error updating setting:', error);
        showToast('error', 'Failed to update setting: ' + error.message);
        loadSettings(); // Reload to reset UI state
    });
}

// Custom modal functions for admin dashboard
function openModal(modalId) {
    // Close any open dropdowns first
    closeAllDropdowns();

    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        modal.style.display = 'flex';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 200);
    }
}

// Transfer Leadership Functions
let transferSelectedUserId = null;
let transferUserSearchTimeout = null;

async function openTransferLeadershipModal(clubId, clubName, currentLeaderId) {
    try {
        console.log('openTransferLeadershipModal called with:', {clubId, clubName, currentLeaderId, type: typeof currentLeaderId});
        let currentLeaderText = 'No Leader';

        // Get current leader info if there is a leader
        if (currentLeaderId && currentLeaderId !== 'null' && currentLeaderId !== null && currentLeaderId !== 'undefined') {
            console.log('Fetching leader info for ID:', currentLeaderId);
            const response = await fetch(`/api/admin/users/${currentLeaderId}`);
            const leaderData = await response.json();

            if (!response.ok) {
                console.error('Error fetching leader data:', leaderData);
                throw new Error(leaderData.error || 'Failed to get leader information');
            }

            currentLeaderText = `${leaderData.username} (${leaderData.email})`;
            console.log('Leader info loaded:', currentLeaderText);
        } else {
            console.log('No current leader, setting to null');
            currentLeaderId = null;
        }

        // Populate modal fields
        document.getElementById('transferClubId').value = clubId;
        document.getElementById('transferClubName').value = clubName;
        document.getElementById('transferCurrentLeaderId').value = currentLeaderId || '';
        document.getElementById('transferCurrentLeader').value = currentLeaderText;

        // Reset search fields
        document.getElementById('transferNewLeaderSearch').value = '';
        document.getElementById('transferNewLeaderId').value = '';
        document.getElementById('transferUserSearchResults').style.display = 'none';
        document.getElementById('transferLeadershipBtn').disabled = true;
        transferSelectedUserId = null;

        openModal('transferLeadershipModal');
    } catch (error) {
        console.error('Error opening transfer modal:', error);
        showToast('error', 'Failed to open transfer modal. Please try again.');
        console.log('Debug - clubId:', clubId, 'clubName:', clubName, 'currentLeaderId:', currentLeaderId);
    }
}

async function searchUsersForTransfer(query) {
    if (!query || query.length < 2) {
        document.getElementById('transferUserSearchResults').style.display = 'none';
        return;
    }

    try {
        const response = await fetch(`/api/admin/users/search?q=${encodeURIComponent(query)}&limit=10`);
        const data = await response.json();

        if (response.ok) {
            displayUserSearchResults(data.users || []);
        } else {
            console.error('Search error:', data.error);
            document.getElementById('transferUserSearchResults').style.display = 'none';
        }
    } catch (error) {
        console.error('Error searching users:', error);
        document.getElementById('transferUserSearchResults').style.display = 'none';
    }
}

function displayUserSearchResults(users) {
    const resultsContainer = document.getElementById('transferUserSearchResults');
    const currentLeaderIdValue = document.getElementById('transferCurrentLeaderId').value;
    const currentLeaderId = currentLeaderIdValue && currentLeaderIdValue !== '' ? parseInt(currentLeaderIdValue) : null;

    if (!users || users.length === 0) {
        resultsContainer.innerHTML = '<div class="user-search-no-results">No users found</div>';
        resultsContainer.style.display = 'block';
        return;
    }

    // Filter out the current leader (if there is one)
    const filteredUsers = currentLeaderId ? users.filter(user => user.id !== currentLeaderId) : users;

    if (filteredUsers.length === 0) {
        resultsContainer.innerHTML = '<div class="user-search-no-results">No other users found</div>';
        resultsContainer.style.display = 'block';
        return;
    }

    const html = filteredUsers.map(user => `
        <div class="user-search-item" onclick="selectUserForTransfer(${user.id}, '${escapeHtml(user.username)}', '${escapeHtml(user.email)}')">
            <div class="user-search-name">${escapeHtml(user.username)}</div>
            <div class="user-search-email">${escapeHtml(user.email)}</div>
        </div>
    `).join('');

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
}

function selectUserForTransfer(userId, username, email) {
    transferSelectedUserId = userId;
    document.getElementById('transferNewLeaderId').value = userId;
    document.getElementById('transferNewLeaderSearch').value = `${username} (${email})`;
    document.getElementById('transferUserSearchResults').style.display = 'none';
    document.getElementById('transferLeadershipBtn').disabled = false;
}

async function confirmTransferLeadership() {
    const clubId = document.getElementById('transferClubId').value;
    const clubName = document.getElementById('transferClubName').value;
    const newLeaderId = document.getElementById('transferNewLeaderId').value;
    const newLeaderSearch = document.getElementById('transferNewLeaderSearch').value;

    if (!newLeaderId) {
        showToast('error', 'Please select a new leader');
        return;
    }

    // Show confirmation
    document.getElementById('confirmTitle').textContent = 'Transfer Club Leadership';
    document.getElementById('confirmMessage').innerHTML = `
        Are you sure you want to transfer leadership of "<strong>${escapeHtml(clubName)}</strong>" to <strong>${escapeHtml(newLeaderSearch)}</strong>?
        <br><br>
        <span style="color: #dc2626; font-size: 0.9rem;">The current leader will become a regular member. This action cannot be undone.</span>
    `;

    pendingAction = 'transferLeadership';
    pendingClubId = clubId;
    pendingNewLeaderId = newLeaderId;

    closeModal('transferLeadershipModal');
    openModal('confirmModal');
}

async function executeTransferLeadership() {
    try {
        const response = await makeSecureRequest(`/api/admin/clubs/${pendingClubId}/transfer-leadership`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                new_leader_id: pendingNewLeaderId
            })
        });

        if (response.ok) {
            showToast('success', 'Club leadership transferred successfully');
            loadRecentClubs();
        } else {
            const error = await response.json();
            showToast('error', error.error || 'Failed to transfer leadership');
        }
    } catch (error) {
        console.error('Error transferring leadership:', error);
        showToast('error', 'Failed to transfer leadership');
    }
}

// Add event listener for user search
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('transferNewLeaderSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(transferUserSearchTimeout);
            transferUserSearchTimeout = setTimeout(() => {
                searchUsersForTransfer(this.value);
            }, 300);
        });

        // Hide search results when clicking outside
        searchInput.addEventListener('blur', function() {
            setTimeout(() => {
                document.getElementById('transferUserSearchResults').style.display = 'none';
            }, 200);
        });

        searchInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                searchUsersForTransfer(this.value);
            }
        });
    }
});

// ===== CONSOLIDATED showAdminSection function with all extensions =====
const _baseShowAdminSection = showAdminSection;
showAdminSection = function(section) {
    // Call the original function
    _baseShowAdminSection(section);

    // Load settings when switching to settings tab
    if (section === 'settings') {
        loadSettings();
    }

    // Load roles when switching to roles tab
    if (section === 'roles') {
        loadRoles();
    }
};

// Banner Management Functions
function toggleBanner() {
    const checkbox = document.getElementById('bannerEnabled');
    const configPanel = document.getElementById('bannerConfigPanel');
    const enabled = checkbox.checked;

    if (enabled) {
        configPanel.style.display = 'block';
        loadBannerSettings();
        updateBannerPreview();
        // Save the enabled state
        updateSetting('banner_enabled', 'true');
    } else {
        configPanel.style.display = 'none';
        updateSetting('banner_enabled', 'false');
    }
}

function loadBannerSettings() {
    // Load current banner settings
    makeSecureRequest('/admin/api/banner-settings')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.settings) {
                const settings = data.settings;
                document.getElementById('bannerTitle').value = settings.title || 'Design Contest';
                document.getElementById('bannerSubtitle').value = settings.subtitle || 'Submit your creative projects and win amazing prizes!';
                document.getElementById('bannerIcon').value = settings.icon || 'fas fa-palette';
                document.getElementById('bannerPrimaryColor').value = settings.primary_color || '#ec3750';
                document.getElementById('bannerSecondaryColor').value = settings.secondary_color || '#d63146';
                document.getElementById('bannerBackgroundColor').value = settings.background_color || '#ffffff';
                document.getElementById('bannerTextColor').value = settings.text_color || '#1a202c';
                document.getElementById('bannerLinkUrl').value = settings.link_url || '/gallery';
                document.getElementById('bannerButtonText').value = settings.link_text || 'Submit Entry';
                document.getElementById('bannerEnabled').checked = settings.enabled === 'true';

                if (settings.enabled === 'true') {
                    document.getElementById('bannerConfigPanel').style.display = 'block';
                }

                updateBannerPreview();
            } else {
                // Load defaults if no settings exist
                resetBannerSettings();
            }
        })
        .catch(error => {
            console.error('Error loading banner settings:', error);
            resetBannerSettings();
        });
}

function updateBannerPreview() {
    const title = document.getElementById('bannerTitle').value || 'Design Contest';
    const subtitle = document.getElementById('bannerSubtitle').value || 'Submit your creative projects and win amazing prizes!';
    const icon = document.getElementById('bannerIcon').value || 'fas fa-palette';
    const primaryColor = document.getElementById('bannerPrimaryColor').value || '#ec3750';
    const secondaryColor = document.getElementById('bannerSecondaryColor').value || '#d63146';
    const backgroundColor = document.getElementById('bannerBackgroundColor').value || '#ffffff';
    const textColor = document.getElementById('bannerTextColor').value || '#1a202c';
    const buttonText = document.getElementById('bannerButtonText').value || 'Submit Entry';

    const preview = document.getElementById('bannerPreview');
    preview.innerHTML = `
        <div style="
            background: ${backgroundColor};
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: ${textColor};
        ">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="
                    width: 50px;
                    height: 50px;
                    background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor});
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 1.25rem;
                ">
                    <i class="${icon}"></i>
                </div>
                <div>
                    <h4 style="margin: 0; font-size: 1.1rem; font-weight: 700; color: ${textColor};">${title}</h4>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: ${textColor}; opacity: 0.8;">${subtitle}</p>
                </div>
            </div>
            <button style="
                background: linear-gradient(135deg, ${primaryColor}, ${secondaryColor});
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            ">
                <i class="fas fa-arrow-right"></i> ${buttonText}
            </button>
        </div>
    `;
}

function saveBannerSettings() {
    const settings = {
        enabled: document.getElementById('bannerEnabled').checked,
        title: document.getElementById('bannerTitle').value,
        subtitle: document.getElementById('bannerSubtitle').value,
        icon: document.getElementById('bannerIcon').value,
        primary_color: document.getElementById('bannerPrimaryColor').value,
        secondary_color: document.getElementById('bannerSecondaryColor').value,
        background_color: document.getElementById('bannerBackgroundColor').value,
        text_color: document.getElementById('bannerTextColor').value,
        link_url: document.getElementById('bannerLinkUrl').value,
        link_text: document.getElementById('bannerButtonText').value
    };

    makeSecureRequest('/admin/api/banner-settings', {
        method: 'POST',
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Banner settings saved successfully!');
        } else {
            showToast('error', data.error || 'Failed to save banner settings');
        }
    })
    .catch(error => {
        console.error('Error saving banner settings:', error);
        showToast('error', 'Failed to save banner settings');
    });
}

function resetBannerSettings() {
    document.getElementById('bannerTitle').value = 'Design Contest';
    document.getElementById('bannerSubtitle').value = 'Submit your creative projects and win amazing prizes!';
    document.getElementById('bannerIcon').value = 'fas fa-palette';
    document.getElementById('bannerPrimaryColor').value = '#ec3750';
    document.getElementById('bannerSecondaryColor').value = '#d63146';
    document.getElementById('bannerBackgroundColor').value = '#ffffff';
    document.getElementById('bannerTextColor').value = '#1a202c';
    document.getElementById('bannerLinkUrl').value = '/gallery';
    document.getElementById('bannerButtonText').value = 'Submit Entry';

    updateBannerPreview();
}

// Manage User Roles Function (integrated into Users tab)
async function manageUserRoles(userId, username, isRoot) {
    const title = `Manage Roles for ${username}${isRoot ? ' (Root User)' : ''}`;

    try {
        // Fetch user's current roles
        const rolesResponse = await makeSecureRequest(`/api/admin/rbac/users/${userId}/roles`);
        const userData = await rolesResponse.json();

        // Fetch all available roles
        const allRolesResponse = await makeSecureRequest('/api/admin/rbac/roles');
        const allRolesData = await allRolesResponse.json();

        const currentRoles = userData.roles || [];
        const availableRoles = allRolesData.roles || [];

        // Build the modal content
        let content = '';

        if (isRoot) {
            content += `
                <div style="background: #fef3c7; border-left: 4px solid #fbbf24; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; color: #92400e; font-weight: 600;">
                        <i class="fas fa-crown"></i> This is the root user account. The super-admin role cannot be removed.
                    </p>
                </div>
            `;
        }

        content += `
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1rem;">Current Roles</h4>
                <div id="currentRolesDisplay" style="display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 40px;">
                    ${currentRoles.length > 0 ?
                        currentRoles.map(role => `
                            <span style="background: #dbeafe; color: #1e40af; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                ${role.display_name}
                                ${(!isRoot || role.name !== 'super-admin') ?
                                    `<button onclick="quickRemoveRole(${userId}, '${role.name}', '${username}')"
                                            style="background: none; border: none; color: #dc2626; cursor: pointer; padding: 0; margin: 0;"
                                            title="Remove role">
                                        <i class="fas fa-times"></i>
                                    </button>` : ''}
                            </span>
                        `).join('') :
                        '<span style="color: #94a3b8; font-style: italic;">No roles assigned</span>'}
                </div>
            </div>

            <div>
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1rem;">Assign New Role</h4>
                <div style="display: flex; gap: 0.75rem;">
                    <select id="roleSelectModal" style="flex: 1; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                        <option value="">Select a role...</option>
                        ${availableRoles.map(role => {
                            const hasRole = currentRoles.some(r => r.name === role.name);
                            return `<option value="${role.name}" ${hasRole ? 'disabled' : ''}>${role.display_name}${hasRole ? ' (already assigned)' : ''}</option>`;
                        }).join('')}
                    </select>
                    <button onclick="quickAssignRole(${userId}, '${username}')" class="btn btn-primary" style="white-space: nowrap; padding: 0.75rem 1.5rem;">
                        <i class="fas fa-plus"></i> Assign
                    </button>
                </div>
                <p style="margin: 0.75rem 0 0 0; color: #64748b; font-size: 0.875rem;">
                    <i class="fas fa-info-circle"></i> Users can have multiple roles. Permissions are cumulative across all assigned roles.
                </p>
            </div>
        `;

        showCustomModal(title, content);

    } catch (error) {
        console.error('Error loading roles:', error);
        showToast('error', 'Failed to load role information');
    }
}

async function quickAssignRole(userId, username) {
    const select = document.getElementById('roleSelectModal');
    const roleName = select.value;

    if (!roleName) {
        showToast('error', 'Please select a role');
        return;
    }

    try {
        const response = await makeSecureRequest(`/api/admin/rbac/users/${userId}/roles`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role_name: roleName })
        });

        const data = await response.json();

        if (data.message) {
            showToast('success', data.message);
            // Refresh the modal content
            closeCustomModal();
            const isRoot = username === 'ethan' || false; // You might need to track this better
            manageUserRoles(userId, username, isRoot);
            // Also refresh the users table
            loadUsers(currentUsersPage, getCurrentUserSearch(), getCurrentUserSort());
        } else {
            showToast('error', data.error || 'Failed to assign role');
        }
    } catch (error) {
        console.error('Error assigning role:', error);
        showToast('error', 'Failed to assign role');
    }
}

async function quickRemoveRole(userId, roleName, username) {
    if (!await confirm(`Remove role "${roleName}" from ${username}?`)) {
        return;
    }

    try {
        const response = await makeSecureRequest(`/api/admin/rbac/users/${userId}/roles/${roleName}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.message) {
            showToast('success', data.message);
            // Refresh the modal content
            closeCustomModal();
            const isRoot = username === 'ethan' || false; // You might need to track this better
            manageUserRoles(userId, username, isRoot);
            // Also refresh the users table
            loadUsers(currentUsersPage, getCurrentUserSearch(), getCurrentUserSort());
        } else {
            showToast('error', data.error || 'Failed to remove role');
        }
    } catch (error) {
        console.error('Error removing role:', error);
        showToast('error', 'Failed to remove role');
    }
}

function showCustomModal(title, content) {
    // Check if custom modal exists, if not create it
    let modal = document.getElementById('customModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 id="customModalTitle"></h2>
                    <button onclick="closeCustomModal()" class="close-btn">&times;</button>
                </div>
                <div class="modal-body" id="customModalBody"></div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    document.getElementById('customModalTitle').innerHTML = title;
    document.getElementById('customModalBody').innerHTML = content;
    modal.style.display = 'flex';
}

function closeCustomModal() {
    const modal = document.getElementById('customModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ============ RBAC Management Functions ============

// Tab switching for role tabs
function showRoleTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.role-tab-content').forEach(content => {
        content.classList.remove('active');
    });

    // Remove active class from all tabs
    document.querySelectorAll('.role-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show the selected tab
    document.getElementById(tabName).classList.add('active');

    // Add active class to the clicked tab
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Load data when switching tabs
    if (tabName === 'system-roles') {
        loadRoles();
    } else if (tabName === 'permissions') {
        loadPermissions();
    }
}

// Initialize RBAC system
async function initializeRBAC() {
    if (!await confirm('This will initialize or update the RBAC system with predefined roles and permissions. Continue?')) {
        return;
    }

    makeSecureRequest('/api/admin/rbac/initialize', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
            loadRoles();
        } else {
            showToast('error', data.error || 'Failed to initialize RBAC');
        }
    })
    .catch(error => {
        console.error('Error initializing RBAC:', error);
        showToast('error', 'Failed to initialize RBAC system');
    });
}

// Load all roles
function loadRoles() {
    const canManageRoles = window.canManageRoles || {{ 'true' if 'system.manage_roles' in user_permissions or current_user.is_admin else 'false' }};

    makeSecureRequest('/api/admin/rbac/roles')
        .then(response => response.json())
        .then(data => {
            // Debug logging
            console.log('[DEBUG] loadRoles - API response:', data);
            if (data.roles && data.roles.length > 0) {
                console.log('[DEBUG] First role sample:', data.roles[0]);
                const roleWithRequires2fa = data.roles.find(r => r.requires_2fa);
                if (roleWithRequires2fa) {
                    console.log('[DEBUG] Found role with requires_2fa:', roleWithRequires2fa);
                }
            }
            
            const container = document.getElementById('rolesContainer');
            if (data.roles && data.roles.length > 0) {
                container.innerHTML = data.roles.map(role => {
                    // Debug logging for each role
                    console.log(`[DEBUG] Building card for ${role.name}, requires_2fa:`, role.requires_2fa);
                    
                    return `
                    <div class="role-card ${role.is_system_role ? 'system-role' : 'custom-role'}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas ${role.is_system_role ? 'fa-shield-alt' : 'fa-star'}"></i>
                                    ${role.display_name}
                                    ${role.requires_2fa ? '<span style="display: inline-flex; align-items: center; gap: 0.375rem; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f; padding: 0.25rem 0.625rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;"><i class="fas fa-shield-alt"></i> 2FA Required</span>' : ''}
                                </h4>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">
                                    ${role.description || 'No description'}
                                </p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <button onclick="viewRoleUsers(${role.id}, '${role.display_name.replace(/'/g, "\\'")}')"
                                        class="btn btn-sm" style="padding: 0.5rem 1rem; background: #3b82f6; color: white;">
                                    <i class="fas fa-users"></i> Assigned Users
                                </button>
                                ${canManageRoles ? `
                                <button onclick="editRoleById(${role.id})"
                                        class="btn btn-sm btn-secondary" style="padding: 0.5rem 1rem;"
                                        data-role-id="${role.id}"
                                        data-role-name="${role.name}"
                                        data-role-display="${role.display_name}"
                                        data-role-description="${(role.description || '').replace(/"/g, '&quot;')}"
                                        data-role-requires-2fa="${String(role.requires_2fa)}"
                                        data-role-permissions='${JSON.stringify(role.permissions)}'>
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="deleteRole(${role.id}, '${role.display_name.replace(/'/g, "\\'")}')"
                                        class="btn btn-sm" style="padding: 0.5rem 1rem; background: #dc2626; color: white;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <h5 style="margin: 0 0 0.5rem 0; color: #475569; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-key"></i> Permissions (${role.permissions.length})
                            </h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${role.permissions.slice(0, 10).map(perm =>
                                    `<span class="permission-badge">${perm}</span>`
                                ).join('')}
                                ${role.permissions.length > 10 ?
                                    `<span class="permission-badge" style="background: #ec3750; color: white;">+${role.permissions.length - 10} more</span>` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
                
                // Debug: Check what's actually in the DOM
                setTimeout(() => {
                    const superAdminButton = container.querySelector('button[data-role-name="super-admin"]');
                    if (superAdminButton) {
                        console.log('[DEBUG] Super-admin button element:', superAdminButton);
                        console.log('[DEBUG] All data attributes:', superAdminButton.dataset);
                        console.log('[DEBUG] data-role-requires-2fa attribute:', superAdminButton.getAttribute('data-role-requires-2fa'));
                    }
                }, 100);
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <i class="fas fa-shield-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">No roles found. System will auto-initialize on next request.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading roles:', error);
            document.getElementById('rolesContainer').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ef4444;">
                    <i class="fas fa-exclamation-circle"></i> Failed to load roles
                </div>
            `;
        });
}

// Load all permissions
function loadPermissions() {
    makeSecureRequest('/api/admin/rbac/permissions')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('permissionsContainer');
            if (data.permissions) {
                const categoryIcons = {
                    'system': 'fa-cogs',
                    'users': 'fa-users',
                    'clubs': 'fa-flag',
                    'content': 'fa-file-alt',
                    'reviews': 'fa-check-circle',
                    'admin': 'fa-crown'
                };

                container.innerHTML = Object.entries(data.permissions).map(([category, perms]) => `
                    <div class="permission-category">
                        <h5>
                            <i class="fas ${categoryIcons[category] || 'fa-key'}"></i>
                            ${category.charAt(0).toUpperCase() + category.slice(1)} Permissions
                        </h5>
                        ${perms.map(perm => `
                            <div class="permission-item">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">
                                            ${perm.display_name}
                                        </div>
                                        <div style="font-size: 0.85rem; color: #64748b;">
                                            ${perm.description}
                                        </div>
                                    </div>
                                    <code style="background: white; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem; color: #ec3750;">
                                        ${perm.name}
                                    </code>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            }
        })
        .catch(error => {
            console.error('Error loading permissions:', error);
            document.getElementById('permissionsContainer').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ef4444;">
                    <i class="fas fa-exclamation-circle"></i> Failed to load permissions
                </div>
            `;
        });
}

// Search users for role assignment
let userSearchTimeout;
function searchUsersForRoles() {
    clearTimeout(userSearchTimeout);
    const searchTerm = document.getElementById('userSearchInput').value.trim();

    if (searchTerm.length < 2) {
        document.getElementById('userRolesContainer').innerHTML = `
            <p style="color: #64748b; text-align: center; padding: 2rem;">
                Enter at least 2 characters to search
            </p>
        `;
        return;
    }

    document.getElementById('userRolesContainer').innerHTML = `
        <p style="color: #64748b; text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin"></i> Searching...
        </p>
    `;

    userSearchTimeout = setTimeout(() => {
        makeSecureRequest(`/api/admin/users?search=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                if (data.users && data.users.length > 0) {
                    // For each user, fetch their roles
                    Promise.all(data.users.map(user =>
                        makeSecureRequest(`/api/admin/rbac/users/${user.id}/roles`)
                            .then(r => r.json())
                            .catch(() => ({ roles: [], permissions: [] }))
                    )).then(userRolesData => {
                        displayUsersWithRoles(data.users, userRolesData);
                    });
                } else {
                    document.getElementById('userRolesContainer').innerHTML = `
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            No users found matching "${searchTerm}"
                        </p>
                    `;
                }
            })
            .catch(error => {
                console.error('Error searching users:', error);
                document.getElementById('userRolesContainer').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <i class="fas fa-exclamation-circle"></i> Search failed
                    </div>
                `;
            });
    }, 500);
}

function displayUsersWithRoles(users, userRolesData) {
    const container = document.getElementById('userRolesContainer');
    container.innerHTML = users.map((user, index) => {
        const userData = userRolesData[index];
        const isRoot = userData.is_root || false;

        return `
            <div class="user-role-card ${isRoot ? 'root-user' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user"></i>
                            ${user.username}
                            ${isRoot ? '<i class="fas fa-crown" style="color: #fbbf24;" title="Root User - Cannot be demoted"></i>' : ''}
                        </h4>
                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">${user.email}</p>
                    </div>
                </div>

                <div style="margin-bottom: 1rem;">
                    <h5 style="margin: 0 0 0.75rem 0; color: #475569; font-size: 0.9rem; font-weight: 600;">
                        <i class="fas fa-shield-alt"></i> Current Roles
                    </h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${userData.roles && userData.roles.length > 0 ?
                            userData.roles.map(role => `
                                <span style="background: #dbeafe; color: #1e40af; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    ${role.display_name}
                                    ${!isRoot || role.name !== 'super-admin' ?
                                        `<button onclick="removeUserRole(${user.id}, '${role.name}')"
                                                style="background: none; border: none; color: #dc2626; cursor: pointer; padding: 0; margin: 0;"
                                                title="Remove role">
                                            <i class="fas fa-times"></i>
                                        </button>` : ''}
                                </span>
                            `).join('') :
                            '<span style="color: #94a3b8; font-style: italic;">No roles assigned</span>'}
                    </div>
                </div>

                <div>
                    <h5 style="margin: 0 0 0.75rem 0; color: #475569; font-size: 0.9rem; font-weight: 600;">
                        <i class="fas fa-plus-circle"></i> Assign New Role
                    </h5>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="roleSelect_${user.id}" style="flex: 1; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;">
                            <option value="">Select a role...</option>
                        </select>
                        <button onclick="assignUserRole(${user.id})" class="btn btn-primary" style="white-space: nowrap;">
                            <i class="fas fa-check"></i> Assign
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // Load available roles into dropdowns
    loadRolesForDropdowns(users);
}

function loadRolesForDropdowns(users) {
    makeSecureRequest('/api/admin/rbac/roles')
        .then(response => response.json())
        .then(data => {
            users.forEach(user => {
                const select = document.getElementById(`roleSelect_${user.id}`);
                if (select && data.roles) {
                    data.roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.name;
                        option.textContent = role.display_name;
                        select.appendChild(option);
                    });
                }
            });
        });
}

function assignUserRole(userId) {
    const select = document.getElementById(`roleSelect_${userId}`);
    const roleName = select.value;

    if (!roleName) {
        showToast('error', 'Please select a role');
        return;
    }

    makeSecureRequest(`/api/admin/rbac/users/${userId}/roles`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role_name: roleName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
            searchUsersForRoles(); // Refresh the list
        } else {
            showToast('error', data.error || 'Failed to assign role');
        }
    })
    .catch(error => {
        console.error('Error assigning role:', error);
        showToast('error', 'Failed to assign role');
    });
}

function removeUserRole(userId, roleName) {
    if (!confirm(`Remove role "${roleName}" from this user?`)) {
        return;
    }

    makeSecureRequest(`/api/admin/rbac/users/${userId}/roles/${roleName}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
            searchUsersForRoles(); // Refresh the list
        } else {
            showToast('error', data.error || 'Failed to remove role');
        }
    })
    .catch(error => {
        console.error('Error removing role:', error);
        showToast('error', 'Failed to remove role');
    });
}

// (showAdminSection already extended above to load roles)

// ============ Custom Role Management Functions ============

async function createNewRole() {
    try {
        // Fetch all permissions
        const permResponse = await makeSecureRequest('/api/admin/rbac/permissions');
        const permData = await permResponse.json();

        const allPermissions = permData.all_permissions || [];

        const content = `
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Role Name <span style="color: #dc2626;">*</span></label>
                <input type="text" id="newRoleName" placeholder="e.g., content-moderator"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.875rem;">
                    Use lowercase with hyphens (e.g., content-moderator)
                </p>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Display Name <span style="color: #dc2626;">*</span></label>
                <input type="text" id="newRoleDisplayName" placeholder="e.g., Content Moderator"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Description</label>
                <textarea id="newRoleDescription" placeholder="What can users with this role do?"
                          style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; min-height: 80px; resize: vertical;"></textarea>
            </div>

            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">
                <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" id="newRoleRequires2FA" 
                           style="margin-top: 0.25rem; margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; color: #92400e; font-size: 1rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-shield-alt"></i> Require Two-Factor Authentication (2FA)
                        </div>
                        <div style="color: #78350f; font-size: 0.875rem; line-height: 1.5;">
                            Force all users with this role to enable 2FA for enhanced security. Users will be prompted to set up 2FA before accessing the dashboard.
                        </div>
                    </div>
                </label>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #1e293b;">Permissions <span style="color: #dc2626;">*</span></label>
                <div style="max-height: 300px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                    ${Object.entries(permData.permissions || {}).map(([category, perms]) => `
                        <div style="margin-bottom: 1.5rem;">
                            <h5 style="margin: 0 0 0.75rem 0; color: #1e293b; font-size: 0.95rem; font-weight: 700; text-transform: capitalize;">
                                <i class="fas fa-folder"></i> ${category}
                            </h5>
                            ${perms.map(perm => `
                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 6px;">
                                    <label style="display: flex; align-items: start; cursor: pointer;">
                                        <input type="checkbox" class="permission-checkbox" value="${perm.name}"
                                               ${perm.name !== 'admin.access_dashboard' && (perm.category === 'admin' || perm.category === 'users' || perm.category === 'clubs' || perm.category === 'system') ? 'data-requires-admin-access="true"' : ''}
                                               style="margin-top: 0.25rem; margin-right: 0.75rem; width: 16px; height: 16px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">${perm.display_name}</div>
                                            <div style="color: #64748b; font-size: 0.85rem; margin-top: 0.15rem;">${perm.description}</div>
                                        </div>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 2rem;">
                <button onclick="event.stopPropagation(); closeCustomModal(); return false;" class="btn btn-secondary">
                    Cancel
                </button>
                <button onclick="event.stopPropagation(); saveNewRole(); return false;" class="btn btn-primary">
                    <i class="fas fa-save"></i> Create Role
                </button>
            </div>
        `;

        showCustomModal('Create New Role', content);

        // Add event listener to handle admin permission dependencies
        setupAdminPermissionDependencies();

    } catch (error) {
        console.error('Error loading permissions:', error);
        showToast('error', 'Failed to load permissions');
    }
}

async function saveNewRole() {
    console.log('[DEBUG] saveNewRole called');
    console.log('[DEBUG] Stack trace:', new Error().stack);
    const name = document.getElementById('newRoleName').value.trim();
    const displayName = document.getElementById('newRoleDisplayName').value.trim();
    const description = document.getElementById('newRoleDescription').value.trim();
    const requires2FA = document.getElementById('newRoleRequires2FA').checked;

    const selectedPerms = Array.from(document.querySelectorAll('.permission-checkbox:checked'))
        .map(cb => cb.value);

    if (!name) {
        showToast('error', 'Please enter a role name');
        return;
    }

    if (!displayName) {
        showToast('error', 'Please enter a display name');
        return;
    }

    if (selectedPerms.length === 0) {
        showToast('error', 'Please select at least one permission');
        return;
    }

    try {
        const response = await makeSecureRequest('/api/admin/rbac/roles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                display_name: displayName,
                description: description,
                requires_2fa: requires2FA,
                permissions: selectedPerms
            })
        });

        const data = await response.json();

        if (data.message) {
            showToast('success', data.message);
            closeCustomModal();
            loadRoles();
        } else {
            showToast('error', data.error || 'Failed to create role');
        }
    } catch (error) {
        console.error('Error creating role:', error);
        showToast('error', 'Failed to create role');
    }
}

// Wrapper function to get role data from button and call editRole
async function editRoleById(roleId) {
    const button = event.target.closest('button');
    const roleName = button.dataset.roleName;
    const roleDisplay = button.dataset.roleDisplay;
    const roleDescription = button.dataset.roleDescription;
    const roleRequires2FA = button.getAttribute('data-role-requires-2fa') === 'true';
    const rolePermissions = JSON.parse(button.dataset.rolePermissions);

    // Debug logging
    console.log('[DEBUG] editRoleById - button datasets:');
    console.log('  data-role-requires-2fa:', button.getAttribute('data-role-requires-2fa'));
    console.log('  roleRequires2FA after conversion:', roleRequires2FA);

    await editRole(roleId, roleName, roleDisplay, roleDescription, rolePermissions, roleRequires2FA);
}

async function editRole(roleId, roleName, roleDisplayName, roleDescription, currentPermissions, currentRequires2FA) {
    try {
        // Debug logging
        console.log('[DEBUG] editRole called with:');
        console.log('  roleId:', roleId);
        console.log('  roleName:', roleName);
        console.log('  currentRequires2FA:', currentRequires2FA);
        console.log('  type of currentRequires2FA:', typeof currentRequires2FA);
        
        // Fetch all permissions
        const permResponse = await makeSecureRequest('/api/admin/rbac/permissions');
        const permData = await permResponse.json();

        // Escape HTML in roleDisplayName and roleDescription for safe display
        const safeDisplayName = (roleDisplayName || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const safeDescription = (roleDescription || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const content = `
            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <p style="margin: 0; color: #92400e; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> You are editing the <strong>${safeDisplayName}</strong> role.
                </p>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Display Name <span style="color: #dc2626;">*</span></label>
                <input type="text" id="editRoleDisplayName" value="${safeDisplayName}"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Description</label>
                <textarea id="editRoleDescription"
                          style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; min-height: 80px; resize: vertical;">${safeDescription}</textarea>
            </div>

            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">
                <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" id="editRoleRequires2FA" ${currentRequires2FA ? 'checked' : ''}
                           style="margin-top: 0.25rem; margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; color: #92400e; font-size: 1rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-shield-alt"></i> Require Two-Factor Authentication (2FA)
                        </div>
                        <div style="color: #78350f; font-size: 0.875rem; line-height: 1.5;">
                            Force all users with this role to enable 2FA for enhanced security. Users will be prompted to set up 2FA before accessing the dashboard.
                        </div>
                    </div>
                </label>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #1e293b;">Permissions <span style="color: #dc2626;">*</span></label>
                <div style="max-height: 300px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                    ${Object.entries(permData.permissions || {}).map(([category, perms]) => `
                        <div style="margin-bottom: 1.5rem;">
                            <h5 style="margin: 0 0 0.75rem 0; color: #1e293b; font-size: 0.95rem; font-weight: 700; text-transform: capitalize;">
                                <i class="fas fa-folder"></i> ${category}
                            </h5>
                            ${perms.map(perm => `
                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 6px;">
                                    <label style="display: flex; align-items: start; cursor: pointer;">
                                        <input type="checkbox" class="permission-checkbox" value="${perm.name}"
                                               ${currentPermissions.includes(perm.name) ? 'checked' : ''}
                                               ${perm.name !== 'admin.access_dashboard' && (perm.category === 'admin' || perm.category === 'users' || perm.category === 'clubs' || perm.category === 'system') ? 'data-requires-admin-access="true"' : ''}
                                               style="margin-top: 0.25rem; margin-right: 0.75rem; width: 16px; height: 16px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">${perm.display_name}</div>
                                            <div style="color: #64748b; font-size: 0.85rem; margin-top: 0.15rem;">${perm.description}</div>
                                        </div>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 2rem;">
                <button onclick="event.stopPropagation(); closeCustomModal(); return false;" class="btn btn-secondary">
                    Cancel
                </button>
                <button onclick="event.stopPropagation(); saveEditedRole(${roleId}); return false;" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        `;

        showCustomModal(`Edit Role: ${safeDisplayName}`, content);

        // Add event listener to handle admin permission dependencies
        setupAdminPermissionDependencies();

    } catch (error) {
        console.error('Error loading role editor:', error);
        showToast('error', 'Failed to load role editor');
    }
}

async function saveEditedRole(roleId) {
    console.log('[DEBUG] saveEditedRole called for roleId:', roleId);
    console.log('[DEBUG] Stack trace:', new Error().stack);
    const displayName = document.getElementById('editRoleDisplayName').value.trim();
    const description = document.getElementById('editRoleDescription').value.trim();
    const requires2FA = document.getElementById('editRoleRequires2FA').checked;

    const selectedPerms = Array.from(document.querySelectorAll('.permission-checkbox:checked'))
        .map(cb => cb.value);

    if (!displayName) {
        showToast('error', 'Please enter a display name');
        return;
    }

    if (selectedPerms.length === 0) {
        showToast('error', 'Please select at least one permission');
        return;
    }

    try {
        const response = await makeSecureRequest(`/api/admin/rbac/roles/${roleId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                display_name: displayName,
                description: description,
                requires_2fa: requires2FA,
                permissions: selectedPerms
            })
        });

        const data = await response.json();

        if (data.message) {
            showToast('success', data.message);
            closeCustomModal();
            loadRoles();
        } else {
            showToast('error', data.error || 'Failed to update role');
        }
    } catch (error) {
        console.error('Error updating role:', error);
        showToast('error', 'Failed to update role');
    }
}

async function deleteRole(roleId, roleDisplayName) {
    // FIRST: Ask for confirmation BEFORE making any API calls
    const confirmed = await confirm(
        `Are you sure you want to delete the "${roleDisplayName}" role?\n\n` +
        `This action cannot be undone.`
    );

    if (!confirmed) {
        return; // User cancelled, stop here
    }

    try {
        // Now try to delete after user confirmed
        const response = await makeSecureRequest(`/api/admin/rbac/roles/${roleId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        // If role is assigned to users (409 conflict)
        if (response.status === 409 && data.requires_confirmation) {
            // Show SECOND confirmation with user count
            const forceConfirmed = await confirm(
                `This role is assigned to ${data.user_count} user(s).\n\n` +
                `Deleting this role will remove it from all users.\n\n` +
                `Are you SURE you want to proceed and remove it from ${data.user_count} user(s)?`
            );

            if (!forceConfirmed) {
                return; // User cancelled second confirmation
            }

            // Delete with force parameter
            const forceResponse = await makeSecureRequest(`/api/admin/rbac/roles/${roleId}?force=true`, {
                method: 'DELETE'
            });

            const forceData = await forceResponse.json();

            if (forceData.message) {
                showToast('success', forceData.message);
                loadRoles();
            } else {
                showToast('error', forceData.error || 'Failed to delete role');
            }
        } else if (data.message) {
            // Role deleted successfully (no users had it)
            showToast('success', data.message);
            loadRoles();
        } else {
            showToast('error', data.error || 'Failed to delete role');
        }
    } catch (error) {
        console.error('Error deleting role:', error);
        showToast('error', 'Failed to delete role');
    }
}

// Setup admin permission dependencies
function setupAdminPermissionDependencies() {
    const adminAccessCheckbox = document.querySelector('.permission-checkbox[value="admin.access_dashboard"]');
    const adminDependentCheckboxes = document.querySelectorAll('.permission-checkbox[data-requires-admin-access="true"]');

    if (!adminAccessCheckbox) return;

    // Function to update dependent checkboxes
    function updateDependentCheckboxes() {
        const isAdminAccessChecked = adminAccessCheckbox.checked;

        adminDependentCheckboxes.forEach(checkbox => {
            if (!isAdminAccessChecked) {
                // If admin access is unchecked, uncheck and disable dependent permissions
                checkbox.checked = false;
                checkbox.disabled = true;
                checkbox.closest('div').style.opacity = '0.5';
                checkbox.closest('div').style.pointerEvents = 'none';
            } else {
                // If admin access is checked, enable dependent permissions
                checkbox.disabled = false;
                checkbox.closest('div').style.opacity = '1';
                checkbox.closest('div').style.pointerEvents = 'auto';
            }
        });
    }

    // Add event listener to admin access checkbox
    adminAccessCheckbox.addEventListener('change', updateDependentCheckboxes);

    // Initialize state
    updateDependentCheckboxes();
}

</script>


<script>
let currentRoleId = null;
let currentRoleName = null;
let roleUserSearchTimeout;

// Open role users modal
async function viewRoleUsers(roleId, roleName) {
    currentRoleId = roleId;
    currentRoleName = roleName;

    document.getElementById('roleUsersRoleName').textContent = roleName;
    document.getElementById('roleUserSearch').value = '';
    document.getElementById('roleUserSearchResults').innerHTML = '<p style="color: #64748b; text-align: center; padding: 1rem;"><i class="fas fa-search"></i> Search for users to add to this role</p>';

    openModal('roleUsersModal');
    await loadRoleUsers();
}

// Load users assigned to role
async function loadRoleUsers() {
    if (!currentRoleId) return;

    try {
        const response = await makeSecureRequest(`/api/admin/rbac/roles/${currentRoleId}/users`);
        const data = await response.json();

        const usersList = document.getElementById('roleUsersList');
        const usersCount = document.getElementById('roleUsersCount');

        if (data.users && data.users.length > 0) {
            usersCount.textContent = data.users.length;
            usersList.innerHTML = data.users.map(user => `
                <div class="user-row" style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    padding: 1rem;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    margin-bottom: 0.75rem;
                    background: white;
                ">
                    <img src="${user.avatar_url || '/static/assets/heidi-avatar.png'}"
                         alt="${user.username}"
                         style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1e293b;">${user.username}</div>
                        <div style="font-size: 0.875rem; color: #64748b;">${user.email}</div>
                        ${user.first_name || user.last_name ?
                            `<div style="font-size: 0.875rem; color: #64748b;">${user.first_name || ''} ${user.last_name || ''}</div>` : ''}
                    </div>
                    <button
                        onclick="removeUserFromRole(${user.id}, '${user.username.replace(/'/g, "\\'")}')"
                        class="btn btn-sm"
                        style="padding: 0.5rem 1rem; background: #dc2626; color: white;"
                    >
                        <i class="fas fa-user-minus"></i> Remove
                    </button>
                </div>
            `).join('');
        } else {
            usersCount.textContent = '0';
            usersList.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #64748b;">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p style="margin: 0; font-size: 1.1rem;">No users assigned to this role yet</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Use the search above to add users</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading role users:', error);
        document.getElementById('roleUsersList').innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ef4444;">
                <i class="fas fa-exclamation-circle"></i> Failed to load users
            </div>
        `;
    }
}

// Search users for adding to role
function searchUsersForRole() {
    clearTimeout(roleUserSearchTimeout);
    const searchTerm = document.getElementById('roleUserSearch').value.trim();

    if (searchTerm.length < 2) {
        document.getElementById('roleUserSearchResults').innerHTML = `
            <p style="color: #64748b; text-align: center; padding: 1rem;">
                <i class="fas fa-search"></i> Type at least 2 characters to search
            </p>
        `;
        return;
    }

    document.getElementById('roleUserSearchResults').innerHTML = `
        <p style="color: #64748b; text-align: center; padding: 1rem;">
            <i class="fas fa-spinner fa-spin"></i> Searching...
        </p>
    `;

    roleUserSearchTimeout = setTimeout(async () => {
        try {
            const response = await makeSecureRequest(`/api/admin/users/search?q=${encodeURIComponent(searchTerm)}`);
            const data = await response.json();

            const resultsContainer = document.getElementById('roleUserSearchResults');

            if (data.users && data.users.length > 0) {
                resultsContainer.innerHTML = data.users.map(user => `
                    <div class="user-row" style="
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        padding: 1rem;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        margin-bottom: 0.75rem;
                        background: white;
                    ">
                        <img src="${user.avatar_url || '/static/assets/heidi-avatar.png'}"
                             alt="${user.username}"
                             style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1e293b;">${user.username}</div>
                            <div style="font-size: 0.875rem; color: #64748b;">${user.email}</div>
                        </div>
                        <button
                            onclick="addUserToRole(${user.id}, '${user.username.replace(/'/g, "\\'")}')"
                            class="btn btn-sm"
                            style="padding: 0.5rem 1rem; background: #16a34a; color: white;"
                        >
                            <i class="fas fa-user-plus"></i> Add to Role
                        </button>
                    </div>
                `).join('');
            } else {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        <i class="fas fa-user-slash"></i> No users found matching "${searchTerm}"
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error searching users:', error);
            document.getElementById('roleUserSearchResults').innerHTML = `
                <div style="text-align: center; padding: 1rem; color: #ef4444;">
                    <i class="fas fa-exclamation-circle"></i> Error searching users
                </div>
            `;
        }
    }, 500);
}

// Add user to role
async function addUserToRole(userId, username) {
    if (!currentRoleId) return;

    try {
        // Get the role name first
        const rolesResponse = await makeSecureRequest('/api/admin/rbac/roles');
        const rolesData = await rolesResponse.json();
        const role = rolesData.roles.find(r => r.id === currentRoleId);

        if (!role) {
            showToast('error', 'Role not found');
            return;
        }

        const response = await makeSecureRequest(`/api/admin/rbac/users/${userId}/roles`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                role_name: role.name  // Send role_name, not role_id
            })
        });

        const data = await response.json();

        if (response.ok) {
            showToast('success', `Added ${username} to ${currentRoleName}`);
            await loadRoleUsers();
            clearRoleUserSearch();
        } else {
            showToast('error', data.error || 'Failed to add user to role');
        }
    } catch (error) {
        console.error('Error adding user to role:', error);
        showToast('error', 'Error adding user to role');
    }
}

// Remove user from role (using universal modal)
function removeUserFromRole(userId, username) {
    if (!currentRoleId) return;

    UniversalModal.confirm(
        `Are you sure you want to remove <strong>${username}</strong> from the <strong>${currentRoleName}</strong> role?<br><span style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem; display: block;">This will revoke all permissions associated with this role for this user.</span>`,
        async function() {
            // Confirmed - execute the removal
            try {
                // Get the role name
                const rolesResponse = await makeSecureRequest('/api/admin/rbac/roles');
                const rolesData = await rolesResponse.json();
                const role = rolesData.roles.find(r => r.id === currentRoleId);

                if (!role) {
                    showToast('error', 'Role not found');
                    return;
                }

                const response = await makeSecureRequest(`/api/admin/rbac/users/${userId}/roles/${encodeURIComponent(role.name)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('success', `Removed ${username} from ${currentRoleName}`);
                    await loadRoleUsers();
                } else {
                    showToast('error', data.error || 'Failed to remove user from role');
                }
            } catch (error) {
                console.error('Error removing user from role:', error);
                showToast('error', 'Error removing user from role');
            }
        },
        null,
        'Remove User from Role'
    );
}

// Clear role user search
function clearRoleUserSearch() {
    document.getElementById('roleUserSearch').value = '';
    document.getElementById('roleUserSearchResults').innerHTML = `
        <p style="color: #64748b; text-align: center; padding: 1rem;">
            <i class="fas fa-search"></i> Search for users to add to this role
        </p>
    `;
}

// Refresh role users list
async function refreshRoleUsers() {
    await loadRoleUsers();
    showToast('success', 'User list refreshed');
}

// Export Data Function
async function exportData(type) {
    console.log('Export started for:', type);

    // Show loading modal with progress bar
    const loadingModal = document.createElement('div');
    loadingModal.id = 'exportLoadingModal';
    loadingModal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); display: flex; align-items: center;
        justify-content: center; z-index: 10000;
    `;
    loadingModal.innerHTML = `
        <div style="background: white; padding: 2.5rem 3rem; border-radius: 12px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); min-width: 400px;">
            <div class="loading-spinner" style="width: 50px; height: 50px; margin: 0 auto 1.5rem;"></div>
            <h3 style="margin: 0 0 0.5rem 0; color: #1a202c;" id="exportStatus">Gathering Data...</h3>
            <p style="margin: 0 0 1.5rem 0; color: #64748b; font-size: 0.9rem;" id="exportSubtext">Please wait while we prepare your export</p>
            <div style="width: 100%; background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 1rem;">
                <div id="exportProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ec3750, #ff6b7a); transition: width 0.3s ease;"></div>
            </div>
            <p style="margin: 0; color: #94a3b8; font-size: 0.8rem;" id="exportTimer">Elapsed: 0s</p>
        </div>
    `;
    document.body.appendChild(loadingModal);

    // Progress simulation
    let progress = 0;
    let startTime = Date.now();
    const progressBar = document.getElementById('exportProgress');
    const timer = document.getElementById('exportTimer');
    const statusText = document.getElementById('exportStatus');
    const subtext = document.getElementById('exportSubtext');

    const progressInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timer.textContent = `Elapsed: ${elapsed}s`;

        // Simulate progress
        if (progress < 30) {
            progress += Math.random() * 5;
        } else if (progress < 60) {
            progress += Math.random() * 3;
        } else if (progress < 90) {
            progress += Math.random() * 1;
        }

        progressBar.style.width = `${Math.min(progress, 95)}%`;

        // Update status messages
        if (progress < 30) {
            statusText.textContent = 'Connecting to server...';
        } else if (progress < 60) {
            statusText.textContent = 'Fetching data...';
        } else {
            statusText.textContent = 'Processing export...';
        }
    }, 200);

    try {
        console.log('Making request to:', `/api/admin/export/${type}`);

        // Use makeSecureRequest for proper auth handling
        const response = await makeSecureRequest(`/api/admin/export/${type}`, {
            method: 'GET',
            credentials: 'same-origin'
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
            let errorMsg = 'Export failed';
            try {
                const errorData = await response.json();
                errorMsg = errorData.error || errorMsg;
            } catch (e) {
                errorMsg = `Server error: ${response.status}`;
            }
            throw new Error(errorMsg);
        }

        const data = await response.json();
        console.log('Export data received:', data.count, 'records');

        // Complete progress
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        statusText.textContent = 'Creating download...';
        subtext.textContent = `Preparing ${data.count} records`;

        // Small delay to show completion
        await new Promise(resolve => setTimeout(resolve, 500));

        // Create downloadable file
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${type}_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        // Remove loading modal
        document.body.removeChild(loadingModal);

        // Show success message
        if (typeof showToast === 'function') {
            showToast('success', `Successfully exported ${data.count} ${type}`);
        } else {
            alert(`Successfully exported ${data.count} ${type}`);
        }

    } catch (error) {
        console.error('Export error:', error);
        clearInterval(progressInterval);

        // Show error in modal
        statusText.textContent = 'Export Failed';
        statusText.style.color = '#ef4444';
        subtext.textContent = error.message || 'An error occurred';
        subtext.style.color = '#ef4444';
        progressBar.style.background = '#ef4444';

        // Remove modal after delay
        setTimeout(() => {
            if (document.body.contains(loadingModal)) {
                document.body.removeChild(loadingModal);
            }
        }, 3000);

        if (typeof showToast === 'function') {
            showToast('error', error.message || 'Failed to export data');
        } else {
            alert('Error: ' + (error.message || 'Failed to export data'));
        }
    }
}

// Initialize Charts
document.addEventListener('DOMContentLoaded', function() {
    // Project Status Chart
    const projectStatusCtx = document.getElementById('projectStatusChart');
    if (projectStatusCtx) {
        new Chart(projectStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Approved', 'Pending', 'Rejected'],
                datasets: [{
                    data: [{{ total_approved_projects|default(0) }}, {{ total_pending_projects|default(0) }}, {{ total_rejected_projects|default(0) }}],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }

    // Hours Distribution Chart
    const hoursCtx = document.getElementById('hoursChart');
    if (hoursCtx) {
        new Chart(hoursCtx, {
            type: 'bar',
            data: {
                labels: ['Total Hours', 'Approved Hours'],
                datasets: [{
                    label: 'Hours',
                    data: [{{ submitted_hours|default(0) }}, {{ approved_hours|default(0) }}],
                    backgroundColor: ['#06b6d4', '#10b981'],
                    borderWidth: 0,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#e2e8f0' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Weighted Grants Chart
    const grantsCtx = document.getElementById('grantsChart');
    if (grantsCtx) {
        new Chart(grantsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Approved Grants', 'Pending Grants'],
                datasets: [{
                    data: [
                        {{ total_approved_weighted_grants|default(0) }},
                        {{ (total_submitted_weighted_grants|default(0) - total_approved_weighted_grants|default(0))|abs }}
                    ],
                    backgroundColor: ['#10b981', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }
});

// Club Team Notes Modal and Functions
function openClubTeamNotesModal(clubId, clubName) {
    const modal = document.getElementById('clubTeamNotesModal');
    if (!modal) {
        console.error('Club team notes modal not found');
        return;
    }
    
    document.getElementById('clubTeamNotesName').textContent = clubName;
    document.getElementById('clubTeamNotesId').value = clubId;
    document.getElementById('clubTeamNotesText').value = '';
    document.getElementById('clubTeamNotesStatus').innerHTML = '';
    
    // Load team notes
    fetch(`/api/clubs/${clubId}/team-notes`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('clubTeamNotesText').value = data.team_notes || '';
            }
        })
        .catch(error => {
            console.error('Error loading team notes:', error);
            showClubTeamNotesStatus('Error loading team notes', 'error');
        });
    
    openModal('clubTeamNotesModal');
}

function saveClubTeamNotes() {
    const clubId = document.getElementById('clubTeamNotesId').value;
    const teamNotes = document.getElementById('clubTeamNotesText').value;
    
    fetch(`/api/clubs/${clubId}/team-notes`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ team_notes: teamNotes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showClubTeamNotesStatus(data.message || 'Team notes saved successfully!', 'success');
        } else {
            showClubTeamNotesStatus(data.error || 'Error saving team notes', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving team notes:', error);
        showClubTeamNotesStatus('Error saving team notes', 'error');
    });
}

function showClubTeamNotesStatus(message, type) {
    const statusDiv = document.getElementById('clubTeamNotesStatus');
    statusDiv.innerHTML = `<div style="padding: 0.75rem; border-radius: 5px; background: ${type === 'success' ? '#d1fae5' : '#fee2e2'}; color: ${type === 'success' ? '#059669' : '#dc2626'}; margin-top: 1rem;">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 3000);
}

// User Creation Functions
function createSingleUser() {
    const username = document.getElementById('newUsername').value;
    const email = document.getElementById('newEmail').value;
    const firstName = document.getElementById('newFirstName').value;
    const lastName = document.getElementById('newLastName').value;
    const password = document.getElementById('newPassword').value;
    
    console.log('Form values:', { username, email, firstName, lastName, password: password ? '***' : '(empty)' });
    
    if (!username || !email || !password) {
        showCreateUserStatus('Please fill in all required fields (username, email, password)', 'error');
        return;
    }
    
    if (password.length < 6) {
        showCreateUserStatus('Password must be at least 6 characters', 'error');
        return;
    }
    
    const statusDiv = document.getElementById('createUserStatus');
    statusDiv.innerHTML = '<div style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Creating user...</div>';
    
    fetch('/api/admin/users/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            username: username.trim(),
            email: email.trim(),
            first_name: firstName.trim(),
            last_name: lastName.trim(),
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showCreateUserStatus('User created successfully!', 'success');
            document.getElementById('createSingleUserForm').reset();
            setTimeout(() => {
                closeModal('createSingleUserModal');
                loadUsers();
            }, 1500);
        } else {
            showCreateUserStatus(data.error || 'Failed to create user', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showCreateUserStatus('Error creating user', 'error');
    });
}

function showCreateUserStatus(message, type) {
    const statusDiv = document.getElementById('createUserStatus');
    statusDiv.innerHTML = `<div style="padding: 0.75rem; border-radius: 5px; background: ${type === 'success' ? '#d1fae5' : '#fee2e2'}; color: ${type === 'success' ? '#059669' : '#dc2626'}; margin-top: 1rem;">${message}</div>`;
}

function downloadCSVTemplate() {
    const csv = 'username,email,first_name,last_name,password\njohn_doe,john@example.com,John,Doe,password123\njane_smith,jane@example.com,Jane,Smith,securepass456';
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'users_template.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

let csvData = null;

function previewCSV() {
    const fileInput = document.getElementById('bulkUsersCSV');
    const file = fileInput.files[0];
    
    if (!file) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
            alert('CSV file must have at least a header row and one data row');
            fileInput.value = '';
            return;
        }
        
        csvData = lines;
        
        // Show preview
        const previewDiv = document.getElementById('csvPreview');
        const contentDiv = document.getElementById('csvPreviewContent');
        const rowCount = document.getElementById('csvRowCount');
        
        const previewLines = lines.slice(0, 6); // Header + 5 rows
        contentDiv.innerHTML = '<pre style="margin: 0;">' + previewLines.join('\n') + '</pre>';
        rowCount.textContent = `Total rows to import: ${lines.length - 1}`;
        
        previewDiv.style.display = 'block';
        document.getElementById('bulkCreateBtn').disabled = false;
    };
    
    reader.readAsText(file);
}

function bulkCreateUsers() {
    if (!csvData || csvData.length < 2) {
        alert('Please upload a valid CSV file');
        return;
    }
    
    const statusDiv = document.getElementById('bulkCreateStatus');
    statusDiv.innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Creating users...</div>';
    
    const btn = document.getElementById('bulkCreateBtn');
    btn.disabled = true;
    
    fetch('/api/admin/users/bulk-create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ csv_data: csvData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const message = `Successfully created ${data.created} user(s)!` +
                (data.failed > 0 ? `<br>${data.failed} failed. Check errors below.` : '');
            statusDiv.innerHTML = `<div style="padding: 1rem; border-radius: 5px; background: #d1fae5; color: #059669;">${message}</div>`;
            
            if (data.errors && data.errors.length > 0) {
                statusDiv.innerHTML += '<div style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto; background: #fee2e2; padding: 0.5rem; border-radius: 5px; font-size: 0.85rem;">' +
                    '<strong>Errors:</strong><br>' + data.errors.join('<br>') +
                    '</div>';
            }
            
            setTimeout(() => {
                if (data.failed === 0) {
                    closeModal('bulkCreateUsersModal');
                }
                loadUsers();
            }, 3000);
        } else {
            statusDiv.innerHTML = `<div style="padding: 1rem; border-radius: 5px; background: #fee2e2; color: #dc2626;">${data.error || 'Failed to create users'}</div>`;
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<div style="padding: 1rem; border-radius: 5px; background: #fee2e2; color: #dc2626;">Error creating users</div>';
        btn.disabled = false;
    });
}
</script>

{% endblock %}
